<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FOOD HOME ‚Äî Listes de courses</title>
    <link rel="stylesheet" href="/static/css/common.css" />
    <link rel="stylesheet" href="/static/css/courses.css" />
    <style>
      /* üé® COULEURS NUTRITIONNELLES - Styles dynamiques */
      .category-btn[data-color="blue"] {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid rgba(59, 130, 246, 0.3);
      }
      .category-btn[data-color="blue"]:hover {
        background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
      }

      .category-btn[data-color="orange"] {
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        border: 2px solid rgba(249, 115, 22, 0.3);
      }
      .category-btn[data-color="orange"]:hover {
        background: linear-gradient(135deg, #fdba74 0%, #fb923c 100%);
      }

      .category-btn[data-color="green"] {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border: 2px solid rgba(16, 185, 129, 0.3);
      }
      .category-btn[data-color="green"]:hover {
        background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%);
      }

      .category-btn[data-color="yellow"] {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid rgba(245, 158, 11, 0.3);
      }
      .category-btn[data-color="yellow"]:hover {
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
      }

      .category-btn[data-color="pink"] {
        background: linear-gradient(135deg, #fecdd3 0%, #fda4af 100%);
        border: 2px solid rgba(244, 63, 94, 0.3);
      }
      .category-btn[data-color="pink"]:hover {
        background: linear-gradient(135deg, #fda4af 0%, #fb7185 100%);
      }

      .category-btn[data-color="gray"] {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border: 2px solid rgba(107, 114, 128, 0.2);
      }
      .category-btn[data-color="gray"]:hover {
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      }

      /* Indicateur nutritionnel */
      .nutrition-indicator {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 4px;
        font-weight: var(--font-weight-medium);
      }

      /* Toggle vues */
      .view-toggle {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        justify-content: center;
      }

      .toggle-btn {
        padding: 12px 28px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-radius: var(--radius-full);
        cursor: pointer;
        transition: all var(--transition-base);
        font-weight: var(--font-weight-semibold);
        font-size: 15px;
      }

      .toggle-btn.active {
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        color: white;
        border-color: transparent;
      }

      /* Grille de cat√©gories */
      .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .category-btn {
        border-radius: var(--radius-xl);
        padding: 24px 16px;
        cursor: pointer;
        transition: all var(--transition-base);
        text-align: center;
        position: relative;
      }

      .category-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
      }

      .category-btn .icon {
        font-size: 40px;
        display: block;
        margin-bottom: 8px;
      }

      .category-btn .name {
        font-weight: var(--font-weight-bold);
        font-size: 14px;
        color: var(--text-primary);
      }

      .category-btn .badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #0ea5e9;
        color: white;
        border-radius: var(--radius-full);
        padding: 4px 10px;
        font-size: 12px;
        font-weight: var(--font-weight-bold);
      }

      /* Drawer (tiroir lat√©ral) */
      .drawer-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 999;
        display: none;
      }

      .drawer-backdrop.active {
        display: block;
        animation: fadeIn 0.2s ease-out;
      }

      .drawer {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 90%;
        max-width: 500px;
        background: white;
        box-shadow: -4px 0 32px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .drawer.active {
        transform: translateX(0);
      }

      .drawer-header {
        padding: 24px;
        border-bottom: 2px solid rgba(59, 130, 246, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        flex-shrink: 0; /* Emp√™cher le header de se comprimer */
      }

      .drawer-header h2 {
        margin: 0;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .drawer-close {
        background: rgba(239, 68, 68, 0.1);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        cursor: pointer;
        font-size: 20px;
        color: #dc2626;
        transition: all var(--transition-fast);
      }

      .drawer-close:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: rotate(90deg);
      }

      .drawer-body {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 24px;
        -webkit-overflow-scrolling: touch; /* Smooth scroll sur iOS */
        min-height: 0; /* Important pour flex */
      }

      .drawer-footer {
        padding: 20px 24px;
        border-top: 2px solid rgba(59, 130, 246, 0.1);
        display: flex;
        gap: 12px;
        background: rgba(240, 249, 255, 0.5);
        flex-shrink: 0; /* Emp√™cher le footer de se comprimer */
      }

      /* Items avec checkbox */
      .item-group {
        margin-bottom: 24px;
      }

      .item-group-title {
        font-size: 15px;
        font-weight: var(--font-weight-bold);
        color: var(--text-secondary);
        margin-bottom: 12px;
        padding-left: 8px;
        border-left: 3px solid #0ea5e9;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: rgba(240, 249, 255, 0.5);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        transition: all var(--transition-fast);
      }

      .checkbox-item:hover {
        background: rgba(224, 242, 254, 0.8);
        transform: translateX(4px);
      }

      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-item label {
        flex: 1;
        cursor: pointer;
        font-size: 15px;
      }

      .checkbox-item.checked {
        opacity: 0.5;
      }

      .checkbox-item.checked label {
        text-decoration: line-through;
      }

      /* Vue liste courses */
      .shopping-view {
        display: none;
      }

      .shopping-view.active {
        display: block;
      }

      .shopping-category {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(59, 130, 246, 0.1);
        border-radius: var(--radius-xl);
        padding: 20px;
        margin-bottom: 16px;
      }

      .shopping-category-header {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: var(--font-weight-extrabold);
        color: #0ea5e9;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(14, 165, 233, 0.2);
      }

      .shopping-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(240, 249, 255, 0.5);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
      }

      .shopping-item input[type="checkbox"] {
        width: 22px;
        height: 22px;
      }

      .shopping-item.checked {
        opacity: 0.5;
      }

      .shopping-item.checked label {
        text-decoration: line-through;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }

      .empty-state::before {
        content: "üõí";
        display: block;
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.6;
      }

      .categories-view,
      .shopping-view {
        display: none;
      }

      .categories-view.active,
      .shopping-view.active {
        display: block;
      }

      /* Info nutritionnelle */
      .nutrition-info {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid rgba(245, 158, 11, 0.2);
        border-radius: var(--radius-lg);
        padding: 16px;
        margin-bottom: 24px;
        font-size: 13px;
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nutrition-info-icon {
        font-size: 28px;
      }

      @media (max-width: 768px) {
        .drawer {
          width: 100%;
          max-width: 100%;
        }

        .categories-grid {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 12px;
        }

        .category-btn {
          padding: 20px 12px;
        }

        .category-btn .icon {
          font-size: 32px;
        }

        /* üîß FIX MOBILE : Assurer que le drawer prend toute la hauteur */
        .drawer {
          height: 100vh;
          height: 100dvh; /* Dynamic viewport height pour iOS */
        }

        .drawer-header {
          padding: 16px 20px;
        }

        .drawer-header h2 {
          font-size: 20px;
        }

        .drawer-body {
          padding: 20px;
          /* Calculer la hauteur disponible */
          max-height: calc(100vh - 160px); /* 100vh - header - footer */
          max-height: calc(100dvh - 160px); /* Pour iOS */
        }

        .drawer-footer {
          padding: 16px 20px;
        }
      }

      /* üé® Toast notification moderne */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 24px;
        border-radius: var(--radius-xl);
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: var(--font-weight-semibold);
        animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
      }

      .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
      }

      @keyframes slideInRight {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      @keyframes fadeOut {
        to { opacity: 0; transform: translateX(400px); }
      }

      /* üé® Modal de confirmation moderne */
      .confirm-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .confirm-modal.active {
        display: flex;
        animation: fadeIn 0.2s ease-out;
      }

      .confirm-content {
        background: white;
        border-radius: var(--radius-2xl);
        padding: 32px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: scaleIn 0.3s ease-out;
      }

      .confirm-title {
        font-size: 20px;
        font-weight: var(--font-weight-bold);
        margin-bottom: 12px;
        color: var(--text-primary);
      }

      .confirm-message {
        font-size: 15px;
        color: var(--text-secondary);
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .confirm-buttons {
        display: flex;
        gap: 12px;
      }

      .confirm-btn {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: var(--radius-lg);
        font-size: 15px;
        font-weight: var(--font-weight-semibold);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .confirm-btn-primary {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
      }

      .confirm-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
      }

      .confirm-btn-secondary {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(0, 0, 0, 0.1);
        color: var(--text-primary);
      }

      .confirm-btn-secondary:hover {
        background: white;
        border-color: rgba(0, 0, 0, 0.2);
      }

    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">üõí</div>
        <h1>FOOD HOME ‚Äî Listes de courses</h1>
        <p class="subtitle">S√©lectionne tes cat√©gories et coche tes produits</p>
      </div>

      <div class="card">
        <!-- Toggle vues -->
        <div class="view-toggle">
          <button class="toggle-btn active" onclick="switchView('categories')">
            üì¶ Cat√©gories
          </button>
          <button class="toggle-btn" onclick="switchView('shopping')">
            üìã Liste courses
          </button>
        </div>

        <!-- VUE CAT√âGORIES -->
        <div id="categoriesView" class="categories-view active">
          <div class="categories-grid" id="categoriesGrid"></div>
        </div>

        <!-- VUE LISTE COURSES -->
        <div id="shoppingView" class="shopping-view">
          <div id="shoppingList"></div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button class="btn btn-primary" onclick="exportList()">
            üì§ Exporter
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            üóëÔ∏è Tout effacer
          </button>
        </div>
      </div>
    </div>

    <!-- Backdrop -->
    <div id="backdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>

    <!-- Drawer dynamique -->
    <div id="drawer" class="drawer">
      <div class="drawer-header">
        <h2 id="drawerTitle"></h2>
        <button class="drawer-close" onclick="closeDrawer()">√ó</button>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      <div class="drawer-footer">
        <button class="btn btn-primary" onclick="saveDrawer()" style="flex: 1">
          üíæ Sauvegarder
        </button>
        <button class="btn btn-secondary" onclick="clearDrawer()">
          üóëÔ∏è Vider
        </button>
      </div>
    </div>

    <script>
      // üé® TOAST MODERNE
      function showToast(message, type = 'success') {
        const oldToast = document.querySelector('.toast');
        if (oldToast) oldToast.remove();

        const toast = document.createElement('div');
        toast.className = `toast ${type === 'error' ? 'error' : ''}`;
        
        const icon = type === 'error' ? '‚ùå' : '‚úÖ';
        toast.innerHTML = `<span style="font-size: 24px;">${icon}</span><span>${message}</span>`;
        
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // üé® CONFIRMATION MODERNE
      let confirmCallback = null;
      
      function showConfirm(title, message, onConfirm) {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');

        titleEl.textContent = title;
        messageEl.textContent = message;
        
        confirmCallback = onConfirm;
        
        modal.classList.add('active');
        
        confirmBtn.onclick = () => {
          modal.classList.remove('active');
          if (confirmCallback) {
            confirmCallback();
            confirmCallback = null;
          }
        };
      }

      function cancelConfirm() {
        document.getElementById('confirmModal').classList.remove('active');
        confirmCallback = null;
      }

      // Fermer la modal en cliquant √† l'ext√©rieur
      window.addEventListener('click', (e) => {
        const modal = document.getElementById('confirmModal');
        if (e.target === modal) {
          cancelConfirm();
        }
      });


      // üé® COULEURS PYRAMIDE ALIMENTAIRE
      const NUTRITION_COLORS = {
        blue: 'blue',    // Base - Hydratation
        orange: 'orange', // C√©r√©ales & F√©culents
        green: 'green',   // Fruits & L√©gumes
        yellow: 'yellow', // Prot√©ines & Laitiers
        pink: 'pink',     // √Ä limiter
        gray: 'gray'      // Hors pyramide
      };

      // D√©finition des cat√©gories avec couleurs nutritionnelles
      const CATEGORIES = {
        // PYRAMIDE ALIMENTAIRE
        boissons: {
          icon: "üíß",
          name: "Boissons",
          order: 1,
          color: 'blue',
          nutritionLevel: 'üü¶ Base - √Ä volont√©',
          items: ["Eau", "Sanpellegrino", "Jus", "Lait", "Th√©", "Caf√©", "Tisanes", "Sirop", "Coca / Soda"],
        },
        cereales: {
          icon: "üåæ",
          name: "C√©r√©ales & F√©culents",
          order: 2,
          color: 'orange',
          nutritionLevel: 'üüß 1 portion/repas',
          items: ["P√¢tes", "Semoule", "Riz", "Bl√©", "Pain", "Quinoa", "Boulgour", "Couscous", "Lentilles corail", "Haricots secs", "Pois chiches"],
        },
        fruits: {
          icon: "üçé",
          name: "Fruits & L√©gumes",
          order: 3,
          priority: true,
          color: 'green',
          nutritionLevel: 'üü© 5 portions/jour',
          groups: {
            Fruits: ["Pommes", "Bananes", "Noix", "Abricots", "Oranges", "Poires", "Raisins", "Fraises", "Kiwis", "Fruits secs"],
            L√©gumes: ["Tomates", "Betteraves", "Salade", "Carottes", "Courgettes", "Brocolis", "Choux", "Poivrons", "Concombres", "Oignons", "Ail"],
          },
        },
        laitiers: {
          icon: "ü•õ",
          name: "Produits laitiers",
          order: 4,
          color: 'yellow',
          nutritionLevel: 'üü® 1 produit/repas',
          items: [
            "Fromages",
            "Yaourts",
            "Fromage blanc",
            "Fromage r√¢p√©",
            "Skyr",
            "Lait",
            "Beurre",
            "Cr√®me liquide",
            "Cr√®me fra√Æche",
            "Mascarpone",
            "Philadelphia",
            "Parmesan",
            "Emmental",
          ],
        },
        proteines: {
          icon: "üçñ",
          name: "Prot√©ines",
          order: 5,
          color: 'yellow',
          nutritionLevel: 'üü® 2 portions/jour',
          groups: {
            Viandes: ["B≈ìuf", "Porc", "Veau", "Poulet", "Agneau", "Canard", "Steak hach√©"],
            Poissons: ["Cabillaud", "Thon", "Truite", "Saumon", "Sardines", "Maquereau", "Crevettes", "Moules"],
            Autres: ["≈íufs", "Tofu"],
          },
        },
        graisses: {
          icon: "üßà",
          name: "Mati√®res grasses",
          order: 6,
          color: 'pink',
          nutritionLevel: 'üü• √Ä limiter',
          items: ["Huile olive", "Huile colza", "Beurre", "Margarine", "Huile tournesol", "Huile noix", "Huile coco"],
        },
        sucres: {
          icon: "üç¨",
          name: "Sucreries",
          order: 7,
          color: 'pink',
          nutritionLevel: 'üü• √Ä limiter',
          items: ["G√¢teaux", "Bonbons", "Chocolats", "Nutella", "Confiture", "Miel", "Sirop d'√©rable", "Biscuits", "Glaces", "Compote"],
        },

        // AUTRES CAT√âGORIES
        condiments: {
          icon: "üßÇ",
          name: "Condiments",
          order: 8,
          color: 'gray',
          items: [
            "Sel",
            "Poivre",
            "√âpices",
            "Ketchup",
            "Moutarde",
            "Mayonnaise",
            "Cornichons",
            "Vinaigre",
            "Sauce soja",
            "Basilic s√©ch√©",
            "Thym",
            "Curry",
            "Paprika",
            "Cannelle",
            "Bouillon cube",
          ],
        },
        transformes: {
          icon: "üçï",
          name: "Produits transform√©s",
          order: 9,
          color: 'pink',
          nutritionLevel: 'üü• √Ä limiter',
          items: [
            "Pain Harris",
            "Farritas",
            "Pizzas",
            "Lardons",
            "Cr√®me fra√Æche",
            "Saucisses Herta",
            "Jambon Herta",
            "Cordons bleus",
            "Nuggets",
            "Cr√®mes desserts",
            "Corn flakes",
            "Biscottes",
            "Surgel√©s l√©gumes",
            "Raviolis",
            "Gnocchis",
            "Quiches",
            "Tartes sal√©es",
            "Soupes",
            "Poissons pan√©s",
            "Steaks v√©g√©taux",
          ],
        },
        apero: {
          icon: "üç∏",
          name: "Ap√©ro",
          order: 10,
          color: 'pink',
          nutritionLevel: 'üü• Occasionnel',
          groups: {
            Alcools: ["Gin", "Aperol", "Tonic", "Get 27", "Bailey", "Vin rouge", "Vin blanc", "Bi√®re", "Whisky", "Rhum"],
            Grignotage: ["Cacahu√®tes", "Chips", "Saucisson", "Olives", "Crackers", "Fruits secs", "Tapenades", "Houmous"],
          },
        },
        hygiene: {
          icon: "üß¥",
          name: "Hygi√®ne",
          order: 11,
          color: 'gray',
          items: [
            "Savon",
            "Shampoing",
            "Cotons-tiges",
            "Coton d√©maquillant",
            "Dentifrice",
            "D√©odorant",
            "Gel douche",
            "Brosse √† dents",
            "Rasoirs",
            "Mousse √† raser",
            "Cr√®me hydratante",
            "Protection solaire",
            "Mouchoirs",
          ],
        },
        menage: {
          icon: "üßπ",
          name: "Produits m√©nagers",
          order: 12,
          color: 'gray',
          items: [
            "Liquide vaisselle",
            "Lessives",
            "Adoucissant",
            "Liti√®re",
            "Calgon",
            "Powerball",
            "Sac poubelle",
            "Aluminium",
            "Papier cuisson",
            "Cellophane",
            "√âponges",
            "Serpilli√®re",
            "Javel",
            "D√©graissant",
            "Produit vitre",
            "Produit sol",
            "Anti-calcaire",
            "Essuie-tout",
          ],
        },
        wc: {
          icon: "üöΩ",
          name: "WC",
          order: 13,
          color: 'gray',
          items: ["Papier toilette", "Canard WC", "D√©sodorisant", "Lingettes WC", "Blocs WC"],
        },
        salon: {
          icon: "üïØÔ∏è",
          name: "Salon",
          order: 14,
          color: 'gray',
          items: ["Bougies", "Allume-feu", "Allumettes", "Parfums d'ambiance"],
        },
        electromenager: {
          icon: "üí°",
          name: "√âlectrom√©nager",
          order: 15,
          color: 'gray',
          items: ["Ampoules", "Piles", "Piles rechargeables", "C√¢bles USB", "Adaptateurs", "Chargeurs"],
        },
        autres: {
          icon: "üì¶",
          name: "Autres",
          order: 16,
          color: 'gray',
          items: [],
        },
      };

      // √âtat
      let selections = {};
      let currentCategory = null;

      // Init
      function init() {
        Object.keys(CATEGORIES).forEach((key) => {
          selections[key] = {};
          const cat = CATEGORIES[key];
          if (cat.items) {
            cat.items.forEach((item) => (selections[key][item] = false));
          } else if (cat.groups) {
            Object.values(cat.groups).forEach((items) => {
              items.forEach((item) => (selections[key][item] = false));
            });
          }
        });

        renderCategories();
        loadFromLocalStorage();
      }

      // Render grille cat√©gories avec couleurs
      function renderCategories() {
        const grid = document.getElementById("categoriesGrid");
        const sorted = Object.entries(CATEGORIES).sort(
          (a, b) => a[1].order - b[1].order
        );

        grid.innerHTML = sorted
          .map(([key, cat]) => {
            const count = Object.values(selections[key]).filter((v) => v).length;
            const colorAttr = cat.color ? `data-color="${cat.color}"` : '';
            const nutritionLabel = cat.nutritionLevel || '';
            
            return `
              <div class="category-btn" ${colorAttr} onclick="openDrawer('${key}')">
                ${count > 0 ? `<div class="badge">${count}</div>` : ""}
                <span class="icon">${cat.icon}</span>
                <span class="name">${cat.name}</span>
                ${nutritionLabel ? `<div class="nutrition-indicator">${nutritionLabel}</div>` : ''}
              </div>
            `;
          })
          .join("");
      }

      // Ouvrir drawer
      function openDrawer(categoryKey) {
        currentCategory = categoryKey;
        const cat = CATEGORIES[categoryKey];

        document.getElementById("drawerTitle").innerHTML = `${cat.icon} ${cat.name}`;

        let html = "";

        if (cat.items) {
          html = cat.items
            .map(
              (item) => `
                <div class="checkbox-item ${selections[categoryKey][item] ? "checked" : ""}">
                  <input type="checkbox" 
                         id="item-${item}" 
                         ${selections[categoryKey][item] ? "checked" : ""}
                         onchange="toggleItem('${categoryKey}', '${item}')">
                  <label for="item-${item}">${item}</label>
                </div>
              `
            )
            .join("");
        } else if (cat.groups) {
          html = Object.entries(cat.groups)
            .map(
              ([groupName, items]) => `
                <div class="item-group">
                  <div class="item-group-title">${groupName}</div>
                  ${items
                    .map(
                      (item) => `
                      <div class="checkbox-item ${selections[categoryKey][item] ? "checked" : ""}">
                        <input type="checkbox" 
                               id="item-${item}" 
                               ${selections[categoryKey][item] ? "checked" : ""}
                               onchange="toggleItem('${categoryKey}', '${item}')">
                        <label for="item-${item}">${item}</label>
                      </div>
                    `
                    )
                    .join("")}
                </div>
              `
            )
            .join("");
        }

        document.getElementById("drawerBody").innerHTML = html;
        document.getElementById("drawer").classList.add("active");
        document.getElementById("backdrop").classList.add("active");
      }

      function closeDrawer() {
        document.getElementById("drawer").classList.remove("active");
        document.getElementById("backdrop").classList.remove("active");
        renderCategories();
      }

      function toggleItem(category, item) {
        selections[category][item] = !selections[category][item];
        const checkbox = document.getElementById(`item-${item}`);
        const parent = checkbox.closest(".checkbox-item");
        parent.classList.toggle("checked");
      }

      function saveDrawer() {
        saveToLocalStorage();
        closeDrawer();
        showToast('‚úÖ Sauvegard√© !');
      }

      function clearDrawer() {
        showConfirm(
          'üóëÔ∏è Vider la cat√©gorie',
          'Voulez-vous vraiment vider cette cat√©gorie ?',
          () => {
            Object.keys(selections[currentCategory]).forEach((item) => {
              selections[currentCategory][item] = false;
            });
            openDrawer(currentCategory);
            showToast('Cat√©gorie vid√©e');
          }
        );
      }

      function switchView(view) {
        document.querySelectorAll(".toggle-btn").forEach((btn) => btn.classList.remove("active"));

        if (view === "categories") {
          document.querySelector(".toggle-btn:first-child").classList.add("active");
          document.getElementById("categoriesView").classList.add("active");
          document.getElementById("shoppingView").classList.remove("active");
        } else {
          document.querySelector(".toggle-btn:last-child").classList.add("active");
          document.getElementById("categoriesView").classList.remove("active");
          document.getElementById("shoppingView").classList.add("active");
          renderShoppingList();
        }
      }

      function renderShoppingList() {
        const container = document.getElementById("shoppingList");
        const hasItems = Object.values(selections).some((cat) =>
          Object.values(cat).some((v) => v)
        );

        if (!hasItems) {
          container.innerHTML =
            '<div class="empty-state">Votre liste est vide<br><span style="font-size: 14px; opacity: 0.7;">Coche des produits dans "Cat√©gories"</span></div>';
          return;
        }

        let html = "";

        Object.entries(CATEGORIES)
          .sort((a, b) => a[1].order - b[1].order)
          .forEach(([key, cat]) => {
            const selected = Object.entries(selections[key]).filter(([_, checked]) => checked);

            if (selected.length > 0) {
              html += `
                <div class="shopping-category">
                  <div class="shopping-category-header">
                    <span>${cat.icon}</span>
                    <span>${cat.name}</span>
                  </div>
                  ${selected
                    .map(
                      ([item, _]) => `
                      <div class="shopping-item">
                        <input type="checkbox" 
                               id="shop-${key}-${item}"
                               onchange="toggleShopItem('${key}', '${item}')">
                        <label for="shop-${key}-${item}">${item}</label>
                      </div>
                    `
                    )
                    .join("")}
                </div>
              `;
            }
          });

        container.innerHTML = html;
      }

      function toggleShopItem(category, item) {
        const checkbox = document.getElementById(`shop-${category}-${item}`);
        const parent = checkbox.closest(".shopping-item");
        parent.classList.toggle("checked");
      }

      function exportList() {
        let text = "üìã LISTE DE COURSES\n\n";

        Object.entries(CATEGORIES)
          .sort((a, b) => a[1].order - b[1].order)
          .forEach(([key, cat]) => {
            const selected = Object.entries(selections[key]).filter(([_, checked]) => checked);

            if (selected.length > 0) {
              text += `\n${cat.icon} ${cat.name.toUpperCase()}\n`;
              selected.forEach(([item, _]) => {
                text += `‚òê ${item}\n`;
              });
            }
          });

        navigator.clipboard.writeText(text);
        showToast("‚úÖ Liste copi√©e dans le presse-papier !");
      }

      function clearAll() {
        showConfirm(
          'üóëÔ∏è Tout effacer',
          'Voulez-vous vraiment effacer toute la liste de courses ?',
          () => {
            Object.keys(selections).forEach((cat) => {
              Object.keys(selections[cat]).forEach((item) => {
                selections[cat][item] = false;
              });
            });

            renderCategories();
            
            // Rafra√Æchir imm√©diatement l'affichage
            if (document.getElementById("shoppingView").classList.contains("active")) {
              renderShoppingList();
            }
            
            saveToLocalStorage();
            showToast('Liste de courses effac√©e');
          }
        );
      }

      function loadFromLocalStorage() {
        try {
          // Charger les s√©lections
          const savedSelections = localStorage.getItem('food_home_selections');
          if (savedSelections) {
            const loaded = JSON.parse(savedSelections);
            Object.assign(selections, loaded);
            console.log('üì• S√©lections charg√©es depuis localStorage');
          }
          
          // Charger les items de la liste (depuis eat.html)
          const shoppingList = JSON.parse(localStorage.getItem('food_home_shopping_list') || '[]');
          if (shoppingList.length > 0) {
            console.log(`üì• ${shoppingList.length} items depuis eat.html`);
            
            shoppingList.forEach((item) => {
              if (!CATEGORIES.autres.items.includes(item)) {
                CATEGORIES.autres.items.push(item);
                selections.autres[item] = true;
              }
            });
          }

          renderCategories();
        } catch (error) {
          console.error("Erreur chargement localStorage:", error);
          renderCategories();
        }
      }

      function saveToLocalStorage() {
        try {
          // Sauvegarder les s√©lections
          localStorage.setItem('food_home_selections', JSON.stringify(selections));
          
          // Sauvegarder aussi la liste compl√®te
          const allItems = [];
          Object.entries(selections).forEach(([cat, items]) => {
            Object.entries(items).forEach(([item, checked]) => {
              if (checked) allItems.push(item);
            });
          });
          
          localStorage.setItem('food_home_shopping_list', JSON.stringify(allItems));
          console.log('üíæ Sauvegard√© dans localStorage');
        } catch (error) {
          console.error("Erreur sauvegarde:", error);
        }
      }

      // üéØ √âCOUTER LES MESSAGES postMessage POUR RAFRA√éCHIR SANS RELOAD
      window.addEventListener('message', (event) => {
        const { type } = event.data || {};
        
        if (type === 'REFRESH_DATA' || type === 'SHOPPING_LIST_UPDATED') {
          console.log('üîÑ Received refresh message, reloading...');
          
          // Rafra√Æchir depuis localStorage
          loadFromLocalStorage();
          
          // Si on est sur la vue shopping, rafra√Æchir aussi
          if (document.getElementById("shoppingView").classList.contains("active")) {
            renderShoppingList();
          }
        }
      });

      window.addEventListener("DOMContentLoaded", init);
    </script>

    <!-- üé® Modal de confirmation moderne -->
    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-content">
        <div class="confirm-title" id="confirmTitle">Confirmation</div>
        <div class="confirm-message" id="confirmMessage">√ätes-vous s√ªr ?</div>
        <div class="confirm-buttons">
          <button class="confirm-btn confirm-btn-secondary" onclick="cancelConfirm()">
            Annuler
          </button>
          <button class="confirm-btn confirm-btn-primary" id="confirmBtn">
            Confirmer
          </button>
        </div>
      </div>
    </div>

  </body>
</html>
