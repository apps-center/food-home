<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-title" content="FOOD HOME">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="/apple-touch-icon.png">
    
    <title>FOOD HOME ‚Äî Listes de courses</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/courses.css" />
    <style>
      /* === GRANDES CAT√âGORIES === */
      .main-categories {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .main-category-btn {
        padding: 16px 28px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-radius: var(--radius-xl);
        cursor: pointer;
        transition: all var(--transition-base);
        font-weight: var(--font-weight-bold);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .main-category-btn:hover {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      }
      
      .main-category-btn.active {
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      
      /* === SOUS-CAT√âGORIES === */
      .subcategories-container {
        display: none;
        animation: fadeIn 0.3s ease-out;
      }
      
      .subcategories-container.active {
        display: block;
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* üé® COULEURS NUTRITIONNELLES - Styles dynamiques */
      .category-btn[data-color="blue"] {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid rgba(59, 130, 246, 0.3);
      }
      .category-btn[data-color="blue"]:hover {
        background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
      }
      .category-btn[data-color="orange"] {
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        border: 2px solid rgba(249, 115, 22, 0.3);
      }
      .category-btn[data-color="orange"]:hover {
        background: linear-gradient(135deg, #fdba74 0%, #fb923c 100%);
      }
      .category-btn[data-color="green"] {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border: 2px solid rgba(16, 185, 129, 0.3);
      }
      .category-btn[data-color="green"]:hover {
        background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%);
      }
      .category-btn[data-color="yellow"] {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid rgba(245, 158, 11, 0.3);
      }
      .category-btn[data-color="yellow"]:hover {
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
      }
      .category-btn[data-color="pink"] {
        background: linear-gradient(135deg, #fecdd3 0%, #fda4af 100%);
        border: 2px solid rgba(244, 63, 94, 0.3);
      }
      .category-btn[data-color="pink"]:hover {
        background: linear-gradient(135deg, #fda4af 0%, #fb7185 100%);
      }
      .category-btn[data-color="gray"] {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border: 2px solid rgba(107, 114, 128, 0.2);
      }
      .category-btn[data-color="gray"]:hover {
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      }
      
      /* Indicateur nutritionnel */
      .nutrition-indicator {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 4px;
        font-weight: var(--font-weight-medium);
      }

      /* Bouton accent (Stock de base) */
      .btn-accent {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
      }

      .btn-accent:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.35);
      }

      /* Bouton Undo flottant */
      .btn-undo {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
        border: none;
        border-radius: var(--radius-full);
        padding: 14px 24px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
        z-index: 999;
        font-weight: var(--font-weight-semibold);
        font-size: 15px;
        transition: all var(--transition-base);
        animation: slideInUp 0.3s ease-out;
      }
      
      .btn-undo:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 12px 32px rgba(139, 92, 246, 0.5);
      }
      
      .btn-undo:active {
        transform: translateY(-2px) scale(1.02);
      }
      
      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(60px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Grille de cat√©gories */
      .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .category-btn {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid rgba(59, 130, 246, 0.15);
        border-radius: var(--radius-xl);
        padding: 24px 16px;
        cursor: pointer;
        transition: all var(--transition-base);
        text-align: center;
        position: relative;
      }

      .category-btn:hover {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
      }

      .category-btn .icon {
        font-size: 40px;
        display: block;
        margin-bottom: 8px;
      }

      .category-btn .name {
        font-weight: var(--font-weight-bold);
        font-size: 14px;
        color: var(--text-primary);
      }

      .category-btn .badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #0ea5e9;
        color: white;
        border-radius: var(--radius-full);
        padding: 4px 10px;
        font-size: 12px;
        font-weight: var(--font-weight-bold);
      }

      /* Drawer (tiroir lat√©ral) */
      .drawer-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 999;
        display: none;
      }

      .drawer-backdrop.active {
        display: block;
        animation: fadeIn 0.2s ease-out;
      }

      .drawer {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 90%;
        max-width: 500px;
        background: white;
        box-shadow: -4px 0 32px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .drawer.active {
        transform: translateX(0);
      }

      .drawer-header {
        padding: 20px 24px;
        border-bottom: 2px solid rgba(59, 130, 246, 0.1);
        display: flex;
        align-items: flex-start;
        gap: 16px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      }

      .drawer-header > div:first-child {
        flex: 1;
      }

      .drawer-header h2 {
        margin: 0 0 12px 0;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .drawer-close {
        background: rgba(0, 0, 0, 0.05);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 24px;
        color: var(--text-muted);
        transition: all var(--transition-fast);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .drawer-close:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        transform: translateX(-4px);
      }

      .drawer-body {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        -webkit-overflow-scrolling: touch;
      }

      .drawer-footer {
        padding: 20px 24px;
        border-top: 2px solid rgba(59, 130, 246, 0.1);
        display: flex;
        gap: 12px;
        background: rgba(240, 249, 255, 0.5);
      }

      /* Items avec checkbox */
      .item-group {
        margin-bottom: 24px;
      }

      .item-group-title {
        font-size: 15px;
        font-weight: var(--font-weight-bold);
        color: var(--text-secondary);
        margin-bottom: 12px;
        padding-left: 8px;
        border-left: 3px solid #0ea5e9;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: rgba(240, 249, 255, 0.5);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        transition: all var(--transition-fast);
      }

      .checkbox-item:hover {
        background: rgba(224, 242, 254, 0.8);
        transform: translateX(4px);
      }

      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-item label {
        flex: 1;
        cursor: pointer;
        font-size: 15px;
      }

      .checkbox-item.checked {
        opacity: 0.5;
      }

      .checkbox-item.checked label {
        text-decoration: line-through;
      }

      /* Vue liste courses */
      .shopping-view {
        display: none;
      }

      .shopping-view.active {
        display: block;
      }

      .shopping-category {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(59, 130, 246, 0.1);
        border-radius: var(--radius-xl);
        padding: 20px;
        margin-bottom: 16px;
        animation: slideInUp 0.3s ease-out;
      }

      .shopping-category-header {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: var(--font-weight-extrabold);
        color: #0ea5e9;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(14, 165, 233, 0.2);
      }

      .shopping-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(240, 249, 255, 0.5);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        transition: all 0.3s ease;
      }

      .shopping-item input[type="checkbox"] {
        width: 22px;
        height: 22px;
      }

      .shopping-item.checked {
        opacity: 0.5;
      }

      .shopping-item.checked label {
        text-decoration: line-through;
      }

      /* Items en stock - Style orange */
      .shopping-item.in-stock {
        background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%) !important;
        border: 2px solid #fb923c !important;
        position: relative;
      }

      .shopping-item.in-stock:hover {
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%) !important;
        border-color: #f97316 !important;
      }

      .shopping-item.in-stock label {
        color: #ea580c;
        font-weight: var(--font-weight-semibold);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
        animation: fadeIn 0.5s ease-out;
      }

      .empty-state::before {
        content: "üõí";
        display: block;
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.6;
      }

      .categories-view {
        display: none;
      }

      .categories-view.active {
        display: block;
      }

      /* Boutons compacts dans le header */
      .btn-compact {
        padding: 8px 16px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 13px;
        font-weight: var(--font-weight-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      
      .btn-compact-primary {
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
      }
      
      .btn-compact-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      
      .btn-compact-secondary {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: var(--text-primary);
      }
      
      .btn-compact-secondary:hover {
        background: white;
        border-color: rgba(239, 68, 68, 0.3);
        color: #dc2626;
      }

      /* Indicateur scroll drawer */
      .drawer-scroll-hint {
        text-align: center;
        padding: 40px 20px 20px;
        color: var(--text-muted);
        font-size: 12px;
        opacity: 0.6;
      }
      
      .drawer-scroll-hint span {
        display: block;
        font-size: 28px;
        margin-bottom: 6px;
        animation: bounce 2s ease-in-out infinite;
      }
      
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-6px); }
      }
      
      .drawer-scroll-hint p {
        margin: 0;
        font-style: italic;
      }

      /* Indicateur scroll shopping list */
      .scroll-indicator-shopping {
        text-align: center;
        padding: 40px 20px 20px;
        color: var(--text-muted);
        font-size: 12px;
        opacity: 0.6;
        margin-top: 30px;
      }
      
      .scroll-indicator-shopping span {
        display: block;
        font-size: 28px;
        margin-bottom: 6px;
        animation: bounceShopping 2s ease-in-out infinite;
      }
      
      @keyframes bounceShopping {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-6px); }
      }
      
      .scroll-indicator-shopping p {
        margin: 0;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .drawer {
          width: 100%;
          max-width: 100%;
          height: 100vh;
          height: 100dvh;
        }
        .categories-grid {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 12px;
        }
        .category-btn {
          padding: 20px 12px;
        }
        .category-btn .icon {
          font-size: 32px;
        }
        .drawer-header {
          padding: 16px 20px;
        }
        .drawer-header h2 {
          font-size: 20px;
        }
        .drawer-body {
          padding: 20px;
          max-height: calc(100vh - 160px);
          max-height: calc(100dvh - 160px);
        }
        .drawer-footer {
          padding: 16px 20px;
        }
        .main-category-btn {
          font-size: 14px;
          padding: 12px 20px;
        }
      }

      /* üé® Toast notification moderne */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 24px;
        border-radius: var(--radius-xl);
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: var(--font-weight-semibold);
        animation: slideInRight 0.3s ease-out,
          fadeOut 0.3s ease-out 2.7s forwards;
      }

      .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
      }

      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      /* Modal de confirmation */
      .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .confirm-modal.active {
        display: flex;
      }

      .confirm-content {
        background: white;
        border-radius: var(--radius-2xl);
        padding: 32px;
        max-width: 400px;
        width: 100%;
        text-align: center;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
        animation: scaleIn 0.2s ease-out;
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .confirm-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      .confirm-content h3 {
        margin: 0 0 16px 0;
        font-size: 24px;
        color: var(--text-primary);
      }

      .confirm-content p {
        color: var(--text-secondary);
        margin-bottom: 24px;
        line-height: 1.6;
      }

      .confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .confirm-btn {
        padding: 12px 32px;
        border: none;
        border-radius: var(--radius-full);
        font-weight: var(--font-weight-semibold);
        font-size: 15px;
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .confirm-btn-primary {
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .confirm-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }

      .confirm-btn-secondary {
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-secondary);
      }

      .confirm-btn-secondary:hover {
        background: rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">üõí</div>
        <h1>FOOD HOME ‚Äî Listes de courses</h1>
        <p class="subtitle">S√©lectionne tes cat√©gories et coche tes produits</p>
      </div>
      <div class="card">
        
        <!-- ‚úÖ NOUVELLES GRANDES CAT√âGORIES -->
        <div class="main-categories">
          <button class="main-category-btn active" onclick="switchMainCategory('alimentaire')">
            üçé Alimentaire
          </button>
          <button class="main-category-btn" onclick="switchMainCategory('hygiene')">
            üß¥ Hygi√®ne
          </button>
          <button class="main-category-btn" onclick="switchMainCategory('menage')">
            üßπ Produits m√©nagers
          </button>
          <button class="main-category-btn" onclick="switchMainCategory('bricolage')">
            üîß Bricolage
          </button>
          <button class="main-category-btn" onclick="switchMainCategory('culture')">
            üìö Culture
          </button>
        </div>

        <!-- VUE CAT√âGORIES AVEC SOUS-CAT√âGORIES -->
        <div id="categoriesView" class="categories-view active">
          
          <!-- Sous-cat√©gories ALIMENTAIRE (affich√©e par d√©faut) -->
          <div id="subcategory-alimentaire" class="subcategories-container active">
            <div class="categories-grid" id="categoriesGrid-alimentaire"></div>
          </div>

          <!-- Sous-cat√©gories HYGI√àNE -->
          <div id="subcategory-hygiene" class="subcategories-container">
            <div class="categories-grid" id="categoriesGrid-hygiene"></div>
          </div>

          <!-- Sous-cat√©gories PRODUITS M√âNAGERS -->
          <div id="subcategory-menage" class="subcategories-container">
            <div class="categories-grid" id="categoriesGrid-menage"></div>
          </div>

          <!-- Sous-cat√©gories BRICOLAGE -->
          <div id="subcategory-bricolage" class="subcategories-container">
            <div class="categories-grid" id="categoriesGrid-bricolage"></div>
          </div>

          <!-- Sous-cat√©gories CULTURE -->
          <div id="subcategory-culture" class="subcategories-container">
            <div class="categories-grid" id="categoriesGrid-culture"></div>
          </div>
        </div>

        <!-- VUE LISTE COURSES (format supermarch√©) -->
        <div id="shoppingView" class="shopping-view">
          <div id="shoppingList"></div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button class="btn btn-accent" onclick="openStockDrawer()">
            üì¶ Stock de base
          </button>
          <button class="btn btn-primary" onclick="exportList()">
            üì§ Exporter
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            üóëÔ∏è Tout effacer
          </button>
        </div>

        <!-- Bouton Undo flottant -->
        <button class="btn-undo" id="undoBtn" onclick="undoLastAction()" style="display: none;">
          <span style="font-size: 20px;">‚Ü©Ô∏è</span>
          <span id="undoText">Annuler</span>
        </button>
        
        <!-- Indicateur scroll pour shopping -->
        <div id="scrollHintShopping" style="display: none; text-align: center; padding: 40px 20px; color: #9ca3af; font-size: 28px; opacity: 0.6;">
          ‚ãØ<br>
          <small style="display: block; font-size: 12px; margin-top: 8px; font-style: italic;">Faites d√©filer vers le haut</small>
        </div>
        
      </div>
    </div>

    <!-- Backdrop -->
    <div id="backdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>

    <!-- Drawer dynamique -->
    <div id="drawer" class="drawer">
      <div class="drawer-header">
        <div style="flex: 1;">
          <h2 id="drawerTitle" style="margin: 0 0 12px 0;"></h2>
          <div style="display: flex; gap: 8px;">
            <button class="btn-compact btn-compact-primary" onclick="saveDrawer()">
              üíæ Sauvegarder
            </button>
            <button class="btn-compact btn-compact-secondary" onclick="clearDrawer()">
              üóëÔ∏è Vider
            </button>
          </div>
        </div>
        <button class="drawer-close" onclick="closeDrawer()">&larr;</button>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
      
      <div class="drawer-scroll-hint">
        ‚ãØ<br>
        <small>Faites d√©filer pour voir tout</small>
      </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-content">
        <div class="confirm-icon">‚ö†Ô∏è</div>
        <h3 id="confirmTitle">Confirmation</h3>
        <p id="confirmMessage">√ätes-vous s√ªr ?</p>
        <div class="confirm-actions">
          <button class="confirm-btn confirm-btn-secondary" onclick="closeConfirmModal()">
            Annuler
          </button>
          <button class="confirm-btn confirm-btn-primary" id="confirmButton">
            Confirmer
          </button>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // D√âFINITION DES CAT√âGORIES PAR GRANDE CAT√âGORIE
      // ============================================
      
      const MAIN_CATEGORIES = {
        alimentaire: {
          name: "Alimentaire",
          icon: "üçé"
        },
        hygiene: {
          name: "Hygi√®ne",
          icon: "üß¥"
        },
        menage: {
          name: "Produits m√©nagers",
          icon: "üßπ"
        },
        bricolage: {
          name: "Bricolage",
          icon: "üîß"
        },
        culture: {
          name: "Culture",
          icon: "üìö"
        }
      };

      // Cat√©gories organis√©es par grande cat√©gorie
      const CATEGORIES = {
        // === ALIMENTAIRE ===
        boissons: {
          mainCategory: "alimentaire",
          icon: "üíß",
          name: "Boissons",
          order: 1,
          color: "blue",
          nutritionLevel: "üü¶ Base - √Ä volont√©",
          items: ["Eau", "Sanpellegrino", "Jus", "Lait", "Th√©", "Caf√©", "Tisanes", "Sirop", "Coca / Soda"]
        },
        cereales: {
          mainCategory: "alimentaire",
          icon: "üåæ",
          name: "C√©r√©ales & F√©culents",
          order: 2,
          color: "orange",
          nutritionLevel: "üüß 1 portion/repas",
          items: ["P√¢tes", "Semoule", "Riz", "Bl√©", "pain de mie", "krisprolls", "Quinoa", "Boulgour", "Couscous", "Lentilles corail", "Haricots secs", "Pois chiches"]
        },
        fruits: {
          mainCategory: "alimentaire",
          icon: "üçé",
          name: "Fruits & L√©gumes",
          order: 3,
          priority: true,
          color: "green",
          nutritionLevel: "üü© 5 portions/jour",
          groups: {
            Fruits: ["Pommes", "Bananes", "Noix", "Abricots", "Oranges", "Poires", "Raisins", "Fraises", "Kiwis", "Fruits secs", "cl√©mentines", "fraises", "framboises", "myrtilles", "mangue", "fruit de la passion", "litchi", "melon", "past√®que"],
            L√©gumes: ["Tomates", "Betteraves", "Salade", "Carottes", "Courgettes", "Brocolis", "Choux", "Poivrons", "Concombres", "Oignons", "Ail", "haricots verts", "c√©leri", "aubergine", "potimarron", "avocat", "choux rouge", "chou blanc", "poireaux"]
          }
        },
        laitiers: {
          mainCategory: "alimentaire",
          icon: "ü•õ",
          name: "Produits laitiers",
          order: 4,
          color: "yellow",
          nutritionLevel: "üü® 1 produit/repas",
          items: ["Fromages", "Yaourts", "Fromage blanc", "Fromage r√¢p√©", "Skyr", "Lait", "Beurre", "Cr√®me liquide", "Cr√®me fra√Æche", "Mascarpone", "saint m√¥ret", "mascarpone", "Philadelphia", "mozzarella", "burrata", "f√™ta", "Parmesan", "Emmental"]
        },
        proteines: {
          mainCategory: "alimentaire",
          icon: "üçñ",
          name: "Prot√©ines",
          order: 5,
          color: "yellow",
          nutritionLevel: "üü® 2 portions/jour",
          groups: {
            Viandes: ["B≈ìuf", "Porc", "Veau", "Poulet", "Agneau", "Canard", "Steak hach√©", "lapin"],
            Poissons: ["Cabillaud", "Thon", "Truite", "Saumon", "Sardines", "Maquereau", "Crevettes", "Moules"],
            Autres: ["≈íufs", "Tofu"]
          }
        },
        graisses: {
          mainCategory: "alimentaire",
          icon: "üßà",
          name: "Mati√®res grasses",
          order: 6,
          color: "pink",
          nutritionLevel: "üü• √Ä limiter",
          items: ["Huile olive", "Huile colza", "Beurre", "Margarine", "Huile tournesol", "Huile noix", "Huile coco"]
        },
        sucres: {
          mainCategory: "alimentaire",
          icon: "üç¨",
          name: "Sucreries",
          order: 7,
          color: "pink",
          nutritionLevel: "üü• √Ä limiter",
          items: ["G√¢teaux", "Bonbons", "Chocolats", "Nutella", "Confiture", "Miel", "Sirop d'√©rable", "Biscuits", "Glaces", "Compote"]
        },
        condiments: {
          mainCategory: "alimentaire",
          icon: "üßÇ",
          name: "Condiments",
          order: 8,
          color: "gray",
          items: ["Sel", "Poivre", "√âpices", "Ketchup", "pesto vert", "pesto rouge", "Moutarde", "Mayonnaise", "Cornichons", "Vinaigre", "Sauce soja", "Basilic s√©ch√©", "Thym", "Curry", "Paprika", "Cannelle", "Bouillon cube"]
        },
        transformes: {
          mainCategory: "alimentaire",
          icon: "üçï",
          name: "Produits transform√©s",
          order: 9,
          color: "pink",
          nutritionLevel: "üü• √Ä limiter",
          items: ["Pain Harris", "Farritas", "Pizzas", "Lardons", "Saucisses Herta", "Jambon Herta", "Cordons bleus", "Nuggets", "Cordons bleus", "Cr√®mes desserts", "Corn flakes", "Surgel√©s l√©gumes", "Raviolis", "Gnocchis", "Quiches", "Tartes sal√©es", "Soupes", "Poissons pan√©s", "Steaks v√©g√©taux", "p√¢te bris√©e", "p√¢te feuillet√©e"]
        },
        apero: {
          mainCategory: "alimentaire",
          icon: "üç∏",
          name: "Ap√©ro",
          order: 10,
          color: "pink",
          nutritionLevel: "üü• Occasionnel",
          groups: {
            Alcools: ["Gin", "Aperol", "Tonic", "Get 27", "Bailey", "Vin rouge", "Vin blanc", "Bi√®re", "Whisky", "Rhum"],
            Grignotage: ["Cacahu√®tes", "Chips", "Saucisson", "Olives", "Crackers", "Fruits secs", "Tapenades", "Houmous", "Gressin"]
          }
        },

        // === HYGI√àNE ===
        hygiene_corps: {
          mainCategory: "hygiene",
          icon: "üß¥",
          name: "Hygi√®ne corps",
          order: 11,
          color: "gray",
          items: ["Savon", "Shampoing", "Gel douche", "D√©odorant", "Cr√®me hydratante", "Protection solaire", "Rasoirs", "Mousse √† raser"]
        },
        hygiene_bucco: {
          mainCategory: "hygiene",
          icon: "ü¶∑",
          name: "Hygi√®ne bucco-dentaire",
          order: 12,
          color: "gray",
          items: ["Dentifrice", "Brosse √† dents", "Fil dentaire", "Bain de bouche"]
        },
        hygiene_accessoires: {
          mainCategory: "hygiene",
          icon: "üíÑ",
          name: "Accessoires",
          order: 13,
          color: "gray",
          items: ["Cotons-tiges", "Coton d√©maquillant", "Mouchoirs"]
        },

        // === PRODUITS M√âNAGERS ===
        menage_vaisselle: {
          mainCategory: "menage",
          icon: "üçΩÔ∏è",
          name: "Vaisselle",
          order: 14,
          color: "gray",
          items: ["Liquide vaisselle", "√âponges", "Powerball"]
        },
        menage_linge: {
          mainCategory: "menage",
          icon: "üëï",
          name: "Linge",
          order: 15,
          color: "gray",
          items: ["Lessives", "Adoucissant", "Calgon"]
        },
        menage_nettoyage: {
          mainCategory: "menage",
          icon: "üßπ",
          name: "Nettoyage",
          order: 16,
          color: "gray",
          items: ["Javel", "D√©graissant", "Produit vitre", "Produit sol", "Anti-calcaire", "Essuie-tout"]
        },
        menage_accessoires: {
          mainCategory: "menage",
          icon: "üì¶",
          name: "Accessoires",
          order: 17,
          color: "gray",
          items: ["Sac poubelle", "Aluminium", "Papier cuisson", "Cellophane"]
        },
        menage_wc: {
          mainCategory: "menage",
          icon: "üöΩ",
          name: "WC",
          order: 18,
          color: "gray",
          items: ["Papier toilette", "Canard WC", "D√©sodorisant", "Lingettes WC", "Blocs WC"]
        },
        menage_animaux: {
          mainCategory: "menage",
          icon: "üê±",
          name: "Animaux",
          order: 19,
          color: "gray",
          items: ["Liti√®re", "Croquettes", "P√¢t√©e"]
        },

        // === BRICOLAGE ===
        bricolage_electricite: {
          mainCategory: "bricolage",
          icon: "üí°",
          name: "√âlectricit√©",
          order: 20,
          color: "gray",
          items: ["Ampoules", "Piles", "Piles rechargeables", "C√¢bles USB", "Adaptateurs", "Chargeurs"]
        },
        bricolage_maison: {
          mainCategory: "bricolage",
          icon: "üî®",
          name: "Maison",
          order: 21,
          color: "gray",
          items: ["Vis", "Clous", "Colle", "Ruban adh√©sif", "Outils"]
        },
        bricolage_salon: {
          mainCategory: "bricolage",
          icon: "üïØÔ∏è",
          name: "Salon",
          order: 22,
          color: "gray",
          items: ["Bougies", "Allume-feu", "Allumettes"]
        },

        // === CULTURE ===
        culture_livres: {
          mainCategory: "culture",
          icon: "üìö",
          name: "Livres",
          order: 23,
          color: "gray",
          items: ["Romans", "BD", "Magazines"]
        },
        culture_multimedia: {
          mainCategory: "culture",
          icon: "üé¨",
          name: "Multim√©dia",
          order: 24,
          color: "gray",
          items: ["DVD", "Blu-ray", "Jeux vid√©o"]
        },
        culture_papeterie: {
          mainCategory: "culture",
          icon: "‚úèÔ∏è",
          name: "Papeterie",
          order: 25,
          color: "gray",
          items: ["Stylos", "Cahiers", "Papier", "Enveloppes"]
        },

        autres: {
          mainCategory: "alimentaire",
          icon: "üì¶",
          name: "Autres",
          order: 99,
          color: "gray",
          items: []
        }
      };

      // === STOCK DE BASE - LISTE FIXE DES ESSENTIELS ===
      const STOCK_BASE_ITEMS = [
        "Sel", "Poivre", "Huile olive", "Huile colza", "Sucre", "Farine",
        "Oignons", "Ail", "√âpices", "Bouillon cube", "Moutarde", "Ketchup",
        "Mayonnaise", "Vinaigre", "Beurre", "Lait", "≈íufs", "Riz", "P√¢tes",
        "Concentr√© de tomate"
      ];

      // √âtat
      let selections = {};
      let stockBase = {};
      let currentCategory = null;
      let undoHistory = [];
      const MAX_UNDO = 10;
      let currentMainCategory = 'alimentaire';

      // ============================================
      // FONCTIONS NAVIGATION GRANDES CAT√âGORIES
      // ============================================
      
      function switchMainCategory(mainCat) {
        currentMainCategory = mainCat;
        
        // Mettre √† jour les boutons
        document.querySelectorAll('.main-category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Afficher les bonnes sous-cat√©gories
        document.querySelectorAll('.subcategories-container').forEach(container => {
          container.classList.remove('active');
        });
        document.getElementById(`subcategory-${mainCat}`).classList.add('active');
      }

      // ============================================
      // INIT
      // ============================================
      
      function init() {
        // Initialiser stockBase
        STOCK_BASE_ITEMS.forEach(item => {
          stockBase[item] = false;
        });

        // Charger stock depuis localStorage
        const savedStock = localStorage.getItem("food_home_stock_base");
        if (savedStock) {
          try {
            const loaded = JSON.parse(savedStock);
            Object.assign(stockBase, loaded);
            console.log("üì¶ Stock de base charg√© depuis localStorage");
          } catch (e) {
            console.error("Erreur chargement stock:", e);
          }
        }
        
        // Initialiser selections
        Object.keys(CATEGORIES).forEach(key => {
          selections[key] = {};
          const cat = CATEGORIES[key];
          if (cat.items) {
            cat.items.forEach(item => selections[key][item] = false);
          } else if (cat.groups) {
            Object.values(cat.groups).forEach(items => {
              items.forEach(item => selections[key][item] = false);
            });
          }
        });

        renderAllCategories();
        loadFromAPI();
        
        // √âcouter les messages de home.html
        window.addEventListener('message', (event) => {
          if (event.data.type === 'SHOW_SHOPPING_LIST') {
            console.log('üì® Message re√ßu : afficher Liste courses');
            switchToShoppingView();
          } else if (event.data.type === 'REFRESH_DATA') {
            console.log('üîÑ Refresh data demand√©');
            loadFromAPI();
          }
        });
      }

      // ============================================
      // RENDER CAT√âGORIES PAR GRANDE CAT√âGORIE
      // ============================================
      
      function renderAllCategories() {
        // Grouper les cat√©gories par mainCategory
        const categoriesByMain = {};
        Object.entries(CATEGORIES).forEach(([key, cat]) => {
          const mainCat = cat.mainCategory || 'alimentaire';
          if (!categoriesByMain[mainCat]) {
            categoriesByMain[mainCat] = [];
          }
          categoriesByMain[mainCat].push([key, cat]);
        });

        // Render chaque groupe dans son grid
        Object.entries(categoriesByMain).forEach(([mainCat, cats]) => {
          const grid = document.getElementById(`categoriesGrid-${mainCat}`);
          if (!grid) return;

          const sorted = cats.sort((a, b) => a[1].order - b[1].order);
          
          grid.innerHTML = sorted.map(([key, cat]) => {
            const count = Object.values(selections[key]).filter(v => v).length;
            const colorAttr = cat.color ? `data-color="${cat.color}"` : '';
            const nutritionLabel = cat.nutritionLevel ? 
              `<div class="nutrition-indicator">${cat.nutritionLevel}</div>` : '';
            
            return `
              <div class="category-btn" ${colorAttr} onclick="openDrawer('${key}')">
                ${count > 0 ? `<div class="badge">${count}</div>` : ""}
                <span class="icon">${cat.icon}</span>
                <span class="name">${cat.name}</span>
                ${nutritionLabel}
              </div>
            `;
          }).join("");
        });
      }

      // ============================================
      // DRAWER
      // ============================================
      
      function openDrawer(categoryKey) {
        currentCategory = categoryKey;
        const cat = CATEGORIES[categoryKey];
        document.getElementById("drawerTitle").innerHTML = `${cat.icon} ${cat.name}`;

        let html = "";
        if (cat.items) {
          html = cat.items.map(item => `
            <div class="checkbox-item ${selections[categoryKey][item] ? "checked" : ""}">
              <input type="checkbox"
                     id="item-${item}"
                     ${selections[categoryKey][item] ? "checked" : ""}
                     onchange="toggleItem('${categoryKey}', '${item}')">
              <label for="item-${item}">${item}</label>
            </div>
          `).join("");
        } else if (cat.groups) {
          html = Object.entries(cat.groups).map(([groupName, items]) => `
            <div class="item-group">
              <div class="item-group-title">${groupName}</div>
              ${items.map(item => `
                <div class="checkbox-item ${selections[categoryKey][item] ? "checked" : ""}">
                  <input type="checkbox"
                         id="item-${item}"
                         ${selections[categoryKey][item] ? "checked" : ""}
                         onchange="toggleItem('${categoryKey}', '${item}')">
                  <label for="item-${item}">${item}</label>
                </div>
              `).join("")}
            </div>
          `).join("");
        }

        document.getElementById("drawerBody").innerHTML = html;
        document.getElementById("drawer").classList.add("active");
        document.getElementById("backdrop").classList.add("active");
      }

      function closeDrawer() {
        document.getElementById("drawer").classList.remove("active");
        document.getElementById("backdrop").classList.remove("active");
      }

      function toggleItem(cat, item) {
        selections[cat][item] = !selections[cat][item];
        const checkbox = document.getElementById(`item-${item}`);
        const parent = checkbox.closest(".checkbox-item");
        parent.classList.toggle("checked");
        renderAllCategories();
      }

      function saveDrawer() {
        if (!currentCategory) return;
        closeDrawer();
        saveToAPI();
        showToast("Cat√©gorie sauvegard√©e ‚úì");
      }

      function clearDrawer() {
        showConfirmModal(
          "Vider cette cat√©gorie ?",
          "Tous les items coch√©s de cette cat√©gorie seront d√©coch√©s.",
          () => {
            Object.keys(selections[currentCategory]).forEach(item => {
              selections[currentCategory][item] = false;
            });
            openDrawer(currentCategory);
            showToast("Cat√©gorie vid√©e");
          }
        );
      }

      // ============================================
      // STOCK DE BASE
      // ============================================
      
      function openStockDrawer() {
        currentCategory = null;
        document.getElementById("drawerTitle").innerHTML = `üì¶ Stock de base`;
        
        let html = `
          <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;">
            Le <strong>stock de base</strong> contient les produits essentiels que vous avez toujours chez vous.
            Ces items seront <strong>automatiquement filtr√©s</strong> de votre liste de courses quand vous cliquez sur "Sauvegarder".
          </p>
          <div class="item-group">
            <div class="item-group-title">üßÇ Produits essentiels</div>
            ${STOCK_BASE_ITEMS.map(item => `
              <div class="checkbox-item ${stockBase[item] ? 'checked' : ''}">
                <input type="checkbox"
                       id="stock-${item}"
                       ${stockBase[item] ? 'checked' : ''}
                       onchange="toggleStockItem('${item}')">
                <label for="stock-${item}">${item}</label>
              </div>
            `).join('')}
          </div>
        `;
        
        document.getElementById("drawerBody").innerHTML = html;
        document.getElementById("drawer").classList.add("active");
        document.getElementById("backdrop").classList.add("active");
      }

      function toggleStockItem(item) {
        stockBase[item] = !stockBase[item];
        const checkbox = document.getElementById(`stock-${item}`);
        const parent = checkbox.closest(".checkbox-item");
        parent.classList.toggle("checked");
        localStorage.setItem("food_home_stock_base", JSON.stringify(stockBase));
      }

      // ============================================
      // VUE SHOPPING (SUPERMARCH√â)
      // ============================================
      
      function switchToShoppingView() {
        // Masquer la vue cat√©gories
        document.getElementById("categoriesView").classList.remove("active");
        // Afficher la vue shopping
        document.getElementById("shoppingView").classList.add("active");
        renderShoppingList();
      }

      function renderShoppingList() {
        const container = document.getElementById("shoppingList");
        const hasItems = Object.values(selections).some(cat =>
          Object.values(cat).some(v => v)
        );

        if (!hasItems) {
          container.innerHTML =
            '<div class="empty-state">Votre liste est vide<br><span style="font-size: 14px; opacity: 0.7;">Coche des produits dans les cat√©gories</span></div>';
          return;
        }

        // Ordre logique de parcours du supermarch√©
        const supermarketOrder = [
          { keys: ["fruits"], name: "Fruits & L√©gumes", icon: "üçé" },
          { keys: ["cereales"], name: "P√¢tes, Riz & F√©culents", icon: "üåæ" },
          { keys: ["laitiers"], name: "Produits Laitiers", icon: "ü•õ" },
          { keys: ["proteines"], name: "Viandes & Poissons", icon: "üçñ" },
          { keys: ["graisses"], name: "Huiles & Mati√®res grasses", icon: "üßà" },
          { keys: ["transformes"], name: "Surgel√©s & Produits transform√©s", icon: "üçï" },
          { keys: ["boissons"], name: "Boissons", icon: "üíß" },
          { keys: ["sucres", "apero"], name: "Snacks & Gourmandises", icon: "üç¨" },
          { keys: ["condiments"], name: "√âpicerie & Condiments", icon: "üßÇ" },
          { keys: ["hygiene_corps", "hygiene_bucco", "hygiene_accessoires"], name: "Hygi√®ne", icon: "üß¥" },
          { keys: ["menage_vaisselle", "menage_linge", "menage_nettoyage", "menage_accessoires", "menage_wc", "menage_animaux"], name: "Entretien", icon: "üßπ" },
          { keys: ["bricolage_electricite", "bricolage_maison", "bricolage_salon"], name: "Bricolage", icon: "üîß" },
          { keys: ["culture_livres", "culture_multimedia", "culture_papeterie"], name: "Culture", icon: "üìö" },
          { keys: ["autres"], name: "Autres", icon: "üì¶" }
        ];

        let html = "";
        supermarketOrder.forEach(section => {
          const sectionItems = [];
          section.keys.forEach(key => {
            const selected = Object.entries(selections[key] || {}).filter(([_, checked]) => checked);
            selected.forEach(([item, _]) => {
              sectionItems.push(item);
            });
          });

          if (sectionItems.length > 0) {
            html += `
              <div class="shopping-category">
                <div class="shopping-category-header">
                  <span>${section.icon}</span>
                  <span>${section.name}</span>
                </div>
                ${sectionItems.map(item => {
                  const isInStock = stockBase[item] === true;
                  const stockClass = isInStock ? ' in-stock' : '';
                  return `
                    <div class="shopping-item${stockClass}">
                      <input type="checkbox" id="shop-${item}" onchange="toggleShoppingItem('${item}')">
                      <label for="shop-${item}">${item}${isInStock ? ' üì¶' : ''}</label>
                    </div>
                  `;
                }).join("")}
              </div>
            `;
          }
        });

        container.innerHTML = html;
      }

      function toggleShoppingItem(item) {
        const checkbox = document.getElementById(`shop-${item}`);
        const parent = checkbox.closest(".shopping-item");
        parent.classList.toggle("checked");
      }

      // ============================================
      // ACTIONS
      // ============================================
      
      function exportList() {
        const allItems = [];
        Object.entries(selections).forEach(([cat, items]) => {
          Object.entries(items).forEach(([item, checked]) => {
            if (checked) allItems.push(item);
          });
        });

        if (allItems.length === 0) {
          showToast("Liste vide", "error");
          return;
        }

        const text = `LISTE DE COURSES - ${new Date().toLocaleDateString('fr-FR')}\n\n${allItems.join('\n')}`;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `courses_${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("Liste export√©e ‚úì");
      }

      function clearAll() {
        showConfirmModal(
          "Tout effacer ?",
          "Tous les items coch√©s seront d√©coch√©s.",
          () => {
            Object.keys(selections).forEach(cat => {
              Object.keys(selections[cat]).forEach(item => {
                selections[cat][item] = false;
              });
            });
            renderAllCategories();
            renderShoppingList();
            saveToAPI();
            showToast("Liste effac√©e");
          }
        );
      }

      function undoLastAction() {
        if (undoHistory.length === 0) return;
        const lastAction = undoHistory.pop();
        // Restaurer l'item
        Object.assign(selections, lastAction.selections);
        renderAllCategories();
        renderShoppingList();
        saveToAPI();
        showToast("Action annul√©e ‚Ü©Ô∏è");
        if (undoHistory.length === 0) {
          document.getElementById("undoBtn").style.display = "none";
        }
      }

      // ============================================
      // STOCKAGE LOCALSTORAGE
      // ============================================
      
      function findCategoryForItem(itemName) {
        const cleanName = itemName.split('(')[0].trim();
        for (const [catKey, cat] of Object.entries(CATEGORIES)) {
          if (cat.items) {
            if (cat.items.includes(itemName)) return catKey;
            if (cat.items.some(item => item.startsWith(cleanName) || cleanName.startsWith(item))) {
              return catKey;
            }
          }
          if (cat.groups) {
            for (const [groupName, items] of Object.entries(cat.groups)) {
              if (items.includes(itemName)) return catKey;
              if (items.some(item => item.startsWith(cleanName) || cleanName.startsWith(item))) {
                return catKey;
              }
            }
          }
        }
        return 'autres';
      }

      async function loadFromAPI() {
        try {
          const savedList = localStorage.getItem('food_home_shopping_list');
          let itemsFromStorage = [];
          
          if (savedList) {
            try {
              itemsFromStorage = JSON.parse(savedList);
              console.log(`üì• ${itemsFromStorage.length} items charg√©s depuis localStorage`);
            } catch (e) {
              console.error("Erreur parsing localStorage:", e);
            }
          }
          
          itemsFromStorage.forEach(item => {
            const categoryKey = findCategoryForItem(item);
            const cat = CATEGORIES[categoryKey];
            
            if (cat.items) {
              if (!cat.items.includes(item)) {
                cat.items.push(item);
              }
            } else if (!cat.groups) {
              if (!CATEGORIES.autres.items) {
                CATEGORIES.autres.items = [];
              }
              if (!CATEGORIES.autres.items.includes(item)) {
                CATEGORIES.autres.items.push(item);
              }
            }
            
            if (selections[categoryKey][item] === undefined) {
              selections[categoryKey][item] = false;
            }
            selections[categoryKey][item] = true;
          });
      
          renderAllCategories();
          if (document.getElementById('shoppingView').classList.contains('active')) {
            renderShoppingList();
          }
        } catch (error) {
          console.error("Erreur chargement:", error);
          renderAllCategories();
        }
      }
      
      async function saveToAPI() {
        const allItems = [];
        Object.entries(selections).forEach(([cat, items]) => {
          Object.entries(items).forEach(([item, checked]) => {
            if (checked) allItems.push(item);
          });
        });
        
        try {
          localStorage.setItem('food_home_shopping_list', JSON.stringify(allItems));
          console.log("üíæ Sauvegarde dans localStorage:", allItems.length, "items");
        } catch (error) {
          console.error("Erreur sauvegarde:", error);
        }
      }

      // ============================================
      // TOAST & MODALS
      // ============================================
      
      function showToast(message, type = "success") {
        const oldToast = document.querySelector(".toast");
        if (oldToast) oldToast.remove();
        const toast = document.createElement("div");
        toast.className = `toast ${type === "error" ? "error" : ""}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
      
      let confirmCallback = null;
      
      function showConfirmModal(title, message, callback) {
        document.getElementById("confirmTitle").textContent = title;
        document.getElementById("confirmMessage").textContent = message;
        confirmCallback = callback;
        document.getElementById("confirmModal").classList.add("active");
      }
      
      function closeConfirmModal() {
        document.getElementById("confirmModal").classList.remove("active");
        confirmCallback = null;
      }
      
      document.getElementById("confirmButton").addEventListener("click", () => {
        if (confirmCallback) {
          confirmCallback();
          confirmCallback = null;
        }
        closeConfirmModal();
      });
      
      document.getElementById("confirmModal").addEventListener("click", (e) => {
        if (e.target.id === "confirmModal") {
          closeConfirmModal();
        }
      });

      // ============================================
      // INIT
      // ============================================
      window.addEventListener("DOMContentLoaded", init);
      
    </script>
  </body>
</html>

