<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quel plat ce soir ?</title>
    <!-- üé® CSS EXTERNES -->
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/eat.css">
    <style>
      /* Toast notification */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 24px;
        border-radius: var(--radius-xl);
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: var(--font-weight-semibold);
        animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
      }
      .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
      }
      @keyframes slideInRight {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes fadeOut {
        to { opacity: 0; transform: translateX(400px); }
      }

      /* Indicateur de scroll en bas de la modale */
      .scroll-indicator {
        text-align: center;
        padding: 40px 20px 20px;
        color: var(--text-muted);
        font-size: 13px;
        opacity: 0.7;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        margin-top: 20px;
      }

      .scroll-indicator span {
        display: block;
        font-size: 32px;
        margin-bottom: 8px;
        animation: bounce 2s ease-in-out infinite;
      }

      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
      }

      .scroll-indicator p {
        margin: 0;
        font-style: italic;
      }

      /* Am√©lioration du scroll sur mobile */
      @media (max-width: 768px) {
        .modal-content {
          max-height: 85vh;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
        }
      }

      .btn-close {
        background: rgba(59, 130, 246, 0.1);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        cursor: pointer;
        font-size: 20px;
        color: #0ea5e9;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .btn-close:hover {
        background: rgba(59, 130, 246, 0.2);
        transform: scale(1.1);
      }
      
      /* üéØ Bouton retour planning (fl√®che) */
      .btn-back-planning {
        background: rgba(139, 92, 246, 0.1) !important;
        color: #8b5cf6 !important;
      }
      
      .btn-back-planning:hover {
        background: rgba(139, 92, 246, 0.2) !important;
        transform: translateX(-4px) !important;
      }
      
      /* üéØ Bouton fermeture directe (croix) */
      .btn-close-direct {
        background: rgba(239, 68, 68, 0.1) !important;
        color: #ef4444 !important;
      }
      
      .btn-close-direct:hover {
        background: rgba(239, 68, 68, 0.2) !important;
      }
      
      /* üéØ Bouton toggle filtres */
      #btn-toggle-filters {
        white-space: nowrap;
        min-width: 120px;
      }
      
      #filter-toggle-icon {
        font-size: 18px;
        font-weight: bold;
        display: inline-block;
        transition: transform var(--transition-base);
      }
      
      #filter-count {
        color: #0ea5e9;
        font-weight: var(--font-weight-bold);
      }
      
      /* üéØ Meal slots cliquables dans le planning */
      .meal-slot.clickable {
        cursor: pointer;
        transition: all var(--transition-base);
      }
      
      .meal-slot.clickable:hover {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: rgba(59, 130, 246, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }
      
      .meal-slot.clickable .meal-content {
        color: #0ea5e9;
        font-weight: var(--font-weight-semibold);
      }
      
      .meal-slot.clickable:hover .meal-content {
        text-decoration: underline;
      }
      
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="logo">üçΩÔ∏è</div>
        <h1>FOOD HOME ‚Äî Recettes</h1>
        <p class="subtitle">D√©couvrez vos recettes favorites</p>
      </div>
      <!-- Filtres -->
      <section class="card">
        <!-- üéØ FILTRES PRINCIPAUX (toujours visibles) -->
        <div class="filters-grid" style="grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 16px;">
          <div class="filter-group">
            <label for="search">Rechercher</label>
            <input type="text" id="search" placeholder="Nom du plat..." />
          </div>
          <div class="filter-group">
            <label for="type">Type</label>
            <select id="type">
              <option value="">Tous types</option>
              <option value="entree">ü•ó Entr√©e</option>
              <option value="plat">üçõ Plat</option>
              <option value="dessert">üç∞ Dessert</option>
            </select>
          </div>
          <!-- üéØ BOUTON TOGGLE FILTRES AVANC√âS -->
          <div class="filter-group" style="display: flex; align-items: flex-end;">
            <button class="btn btn-secondary" id="btn-toggle-filters" onclick="toggleAdvancedFilters()">
              <span id="filter-toggle-icon">+</span> Filtres <span id="filter-count"></span>
            </button>
          </div>
        </div>

        <!-- üéØ FILTRES AVANC√âS (masqu√©s par d√©faut) -->
        <div id="advancedFilters" style="display: none; margin-bottom: 16px;">
          <div class="filters-grid">
            <div class="filter-group">
              <label for="saison">Saison</label>
              <select id="saison">
                <option value="">Toutes</option>
                <option value="printemps">Printemps</option>
                <option value="ete">√ât√©</option>
                <option value="automne">Automne</option>
                <option value="hiver">Hiver</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="regime">R√©gime</label>
              <select id="regime">
                <option value="">Tous</option>
                <option value="rapide">Rapide</option>
                <option value="facile">Facile</option>
                <option value="equilibre">√âquilibr√©</option>
                <option value="vegetarien">V√©g√©tarien</option>
                <option value="viande">Viande</option>
                <option value="poisson">Poisson</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="proteine">Prot√©ine</label>
              <select id="proteine">
                <option value="">Toutes</option>
                <option value="volaille">Volaille</option>
                <option value="viande">Viande</option>
                <option value="poisson">Poisson</option>
                <option value="porc">Porc</option>
                <option value="vegetarien">V√©g√©tarien</option>
              </select>
            </div>
          </div>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap">
          <button class="btn btn-accent" id="btn-generate-week">
            üìÖ G√©n√©rer planning famille (5 jours)
          </button>
          <button class="btn btn-primary" id="btn-random">
            üé≤ Plat au hasard
          </button>
          <button class="btn btn-secondary" id="btn-reset">
            üîÑ R√©initialiser
          </button>
        </div>
      </section>
      <!-- R√©sultats -->
      <div id="results">
        <div class="loading">Chargement des recettes...</div>
      </div>
    </div>
    <!-- Modal d√©tail recette -->
    <div class="modal" id="recipeModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title"></h2>
          <!-- üéØ DEUX BOUTONS : Retour planning OU Fermeture directe -->
          <div style="display: flex; gap: 8px;">
            <button class="btn-close btn-back-planning" id="btn-back-planning" title="Retour au planning" style="display: none;">
              ‚Üê
            </button>
            <button class="btn-close btn-close-direct" id="btn-close-modal" title="Fermer">
              √ó
            </button>
          </div>
        </div>
        <div id="modal-tags" class="tags"></div>
        <div id="modal-meta" class="recipe-meta"></div>

        <!-- Bouton d√©plac√© en haut pour accessibilit√© mobile -->
        <button class="btn btn-primary" id="btn-add-shopping" style="width: 100%; margin: 20px 0;">
          üõí Ajouter √† la liste de courses
        </button>

        <div class="ingredients-list">
          <h4>üõí Ingr√©dients</h4>
          <ul id="modal-ingredients"></ul>
        </div>
        <div class="instructions-list">
          <h4>üë®‚Äçüç≥ Pr√©paration</h4>
          <p id="modal-instructions"></p>
        </div>

        <!-- Indicateur de scroll pour mobile -->
        <div class="scroll-indicator">
          <span>‚ãØ</span>
          <p>Faites d√©filer pour voir toute la recette</p>
        </div>
      </div>
    </div>
    <!-- Modal planning semaine -->
    <div class="modal" id="planningModal">
      <div class="modal-content large">
        <div class="modal-header">
          <h2>üìÖ Planning de la semaine</h2>
          <button class="btn-close" id="btn-close-planning">√ó</button>
        </div>
        <div class="alert-info">
          üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Planning pour une famille de 4 (2 adultes + 2 enfants) - Lundi au Vendredi
        </div>
        <!-- üéØ BOUTONS D√âPLAC√âS EN HAUT en version compacte -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
          <button class="btn btn-primary" id="btn-export-planning" style="padding: 10px 20px; font-size: 14px;">
            üõí Exporter tous les ingr√©dients
          </button>
          <button class="btn btn-secondary" id="btn-regenerate" style="padding: 10px 20px; font-size: 14px;">
            üîÑ R√©g√©n√©rer le planning
          </button>
        </div>
        <div class="week-grid" id="weekGrid"></div>
      </div>
    </div>
    <script>
      // ============================================
      // VARIABLES GLOBALES
      // ============================================
      let allRecipes = [];
      let currentRecipe = null;
      let weeklyPlanning = {};
      const DAYS = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi"];
      const MEALS = ["dejeuner", "diner"];
      // Elements DOM
      const searchInput = document.getElementById("search");
      const typeSelect = document.getElementById("type");
      const saisonSelect = document.getElementById("saison");
      const regimeSelect = document.getElementById("regime");
      const proteineSelect = document.getElementById("proteine");
      const btnRandom = document.getElementById("btn-random");
      const btnReset = document.getElementById("btn-reset");
      const btnGenerateWeek = document.getElementById("btn-generate-week");
      const resultsDiv = document.getElementById("results");
      const modal = document.getElementById("recipeModal");
      const planningModal = document.getElementById("planningModal");
      const btnCloseModal = document.getElementById("btn-close-modal");
      const btnClosePlanning = document.getElementById("btn-close-planning");
      const btnAddToShopping = document.getElementById("btn-add-shopping");
      const btnExportPlanning = document.getElementById("btn-export-planning");
      const btnRegenerate = document.getElementById("btn-regenerate");
      const weekGrid = document.getElementById("weekGrid");
      // ============================================
      // CHARGEMENT DES RECETTES
      // ============================================
      function loadRecipes() {
        resultsDiv.innerHTML = '<div class="loading">Chargement des recettes...</div>';
        fetch('/recipes.json')
          .then(response => {
            console.log('Fetch status:', response.status);
            if (!response.ok) {
              throw new Error('Fetch failed with status ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            console.log('Recipes loaded:', data.length);
            allRecipes = data;
            filterAndRender();
          })
          .catch(error => {
            console.error('Erreur chargement recettes:', error);
            showError('Erreur de chargement des recettes. Veuillez r√©essayer.');
          });
      }
      // ============================================
      // FILTRAGE
      // ============================================
      function filterRecipes() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const type = typeSelect.value;
        const saison = saisonSelect.value;
        const regime = regimeSelect.value;
        const proteine = proteineSelect.value;
        return allRecipes.filter((recipe) => {
          // Recherche par nom
          if (searchTerm && !recipe.nom.toLowerCase().includes(searchTerm)) {
            return false;
          }
          // Filtre type
          if (type && recipe.type_repas !== type) {
            return false;
          }
          // Filtre saison
          if (saison) {
            const saisons = recipe.saisons.split("|");
            if (!saisons.includes(saison) && !saisons.includes("toute")) {
              return false;
            }
          }
          // Filtre r√©gime
          if (regime) {
            const diets = recipe.diets.split("|");
            if (!diets.includes(regime)) {
              return false;
            }
          }
          // Filtre prot√©ine
          if (proteine && recipe.proteine !== proteine) {
            return false;
          }
          return true;
        });
      }
      function filterAndRender() {
        const filtered = filterRecipes();
        renderRecipes(filtered);
      }
      // ============================================
      // RENDU DES RECETTES
      // ============================================
      function renderRecipes(recipes) {
        resultsDiv.innerHTML = "";
        if (recipes.length === 0) {
          resultsDiv.innerHTML =
            '<div class="empty">üòî Aucune recette trouv√©e avec ces filtres</div>';
          return;
        }
        recipes.forEach((recipe) => {
          const card = createRecipeCard(recipe);
          resultsDiv.appendChild(card);
        });
      }
      function createRecipeCard(recipe) {
        const card = document.createElement("article");
        card.className = "recipe-card";
        card.onclick = () => openRecipeModal(recipe);
        const saisons = recipe.saisons.split("|").filter((s) => s);
        const diets = recipe.diets.split("|").filter((d) => d);
        const typeIcon = getTypeIcon(recipe.type_repas);
        card.innerHTML = `
          <h3>${typeIcon} ${recipe.nom}</h3>
          <div class="tags">
            ${saisons.map((s) => `<span class="tag">${s}</span>`).join("")}
            ${diets
              .slice(0, 2)
              .map((d) => `<span class="tag">${d}</span>`)
              .join("")}
          </div>
          <div class="recipe-meta">
            <span>‚è±Ô∏è ${recipe.temps} min</span>
            <span>ü•© ${recipe.proteine}</span>
            ${recipe.kidsFriendly === "Oui" ? "<span>üë∂ Kids</span>" : ""}
          </div>
        `;
        return card;
      }
      function getTypeIcon(type) {
        const icons = {
          entree: "ü•ó",
          plat: "üçõ",
          dessert: "üç∞",
        };
        return icons[type] || "üçΩÔ∏è";
      }
      // ============================================
      // G√âN√âRATEUR DE PLANNING INTELLIGENT
      // ============================================
      function generateWeeklyPlanning() {
        // R√©initialiser
        weeklyPlanning = {};
        // Filtrer les recettes adapt√©es aux enfants et plats uniquement
        const kidsRecipes = allRecipes.filter(
          (r) => r.kidsFriendly === "Oui" && r.type_repas === "plat"
        );
        if (kidsRecipes.length < 10) {
          showToast("Pas assez de recettes adapt√©es aux enfants disponibles");
          return;
        }
        // S√©parer par cat√©gories
        const quickRecipes = kidsRecipes.filter(
          (r) => parseInt(r.temps) <= 30 || r.diets.includes("rapide")
        );
        const standardRecipes = kidsRecipes.filter(
          (r) => parseInt(r.temps) > 30 && parseInt(r.temps) <= 60
        );
        // Tracker des prot√©ines utilis√©es pour varier
        const usedProteins = {};
        const selectedRecipes = [];
        // Fonction pour s√©lectionner une recette avec vari√©t√©
        function selectRecipe(pool, preferQuick = false) {
          const available = pool.filter(
            (r) =>
              !selectedRecipes.includes(r.id) &&
              (!usedProteins[r.proteine] || usedProteins[r.proteine] < 2)
          );
          if (available.length === 0)
            return pool[Math.floor(Math.random() * pool.length)];
          const recipe =
            available[Math.floor(Math.random() * available.length)];
          selectedRecipes.push(recipe.id);
          usedProteins[recipe.proteine] =
            (usedProteins[recipe.proteine] || 0) + 1;
          return recipe;
        }
        // G√©n√©rer 10 repas (5 jours √ó 2 repas)
        DAYS.forEach((day, dayIndex) => {
          weeklyPlanning[day] = {};
          // D√©jeuner : privil√©gier les plats rapides
          weeklyPlanning[day]["dejeuner"] = selectRecipe(
            quickRecipes.length > 0 ? quickRecipes : kidsRecipes,
            true
          );
          // D√Æner : mixer rapides et standards
          const dinnerPool =
            dayIndex < 3 ? quickRecipes : [...quickRecipes, ...standardRecipes];
          weeklyPlanning[day]["diner"] = selectRecipe(
            dinnerPool.length > 0 ? dinnerPool : kidsRecipes
          );
        });
        // Afficher le planning
        renderWeeklyPlanning();
        planningModal.classList.add("active");
      }
      function renderWeeklyPlanning() {
        weekGrid.innerHTML = "";
        DAYS.forEach((day) => {
          const dayCard = document.createElement("div");
          dayCard.className = "day-card";
          const dejeunerRecipe = weeklyPlanning[day]?.["dejeuner"];
          const dinerRecipe = weeklyPlanning[day]?.["diner"];
          dayCard.innerHTML = `
            <div class="day-name">${day}</div>
           
            <div class="meal-slot ${dejeunerRecipe ? 'clickable' : ''}" ${dejeunerRecipe ? `onclick="openRecipeFromPlanning('${day}', 'dejeuner')"` : ''}>
              <div class="meal-label">‚òÄÔ∏è D√©jeuner</div>
              <div class="meal-content">
                ${dejeunerRecipe ? dejeunerRecipe.nom : "Aucune recette"}
              </div>
            </div>
            <div class="meal-slot ${dinerRecipe ? 'clickable' : ''}" ${dinerRecipe ? `onclick="openRecipeFromPlanning('${day}', 'diner')"` : ''}>
              <div class="meal-label">üåô D√Æner</div>
              <div class="meal-content">
                ${dinerRecipe ? dinerRecipe.nom : "Aucune recette"}
              </div>
            </div>
          `;
          weekGrid.appendChild(dayCard);
        });
      }
      function exportPlanningToShoppingList() {
        const allIngredients = new Set();
        DAYS.forEach((day) => {
          ["dejeuner", "diner"].forEach((meal) => {
            const recipe = weeklyPlanning[day]?.[meal];
            if (recipe) {
              recipe.ingredients.split("|").forEach((ing) => {
                if (ing.trim()) allIngredients.add(ing.trim());
              });
            }
          });
        });
        if (allIngredients.size === 0) {
          showToast("Aucun ingr√©dient √† exporter");
          return;
        }
        // Sauvegarder dans localStorage
        let currentList = JSON.parse(localStorage.getItem('food_home_shopping_list') || '[]');
        const newItems = Array.from(allIngredients).filter(item => !currentList.includes(item));
        currentList = [...currentList, ...newItems];
        localStorage.setItem('food_home_shopping_list', JSON.stringify(currentList));
        
        // Notifier le parent pour refresh
        window.parent.postMessage({
          type: 'SHOPPING_LIST_UPDATED'
        }, '*');
        
        showToast(`‚úÖ ${newItems.length} ingr√©dient(s) ajout√©(s) √† la liste de courses !`);
      }
      // ============================================
      // MODAL RECETTE
      // ============================================
      function openRecipeModal(recipe) {
        currentRecipe = recipe;
        document.getElementById("modal-title").textContent = recipe.nom;
        
        // üéØ G√©rer l'affichage des boutons selon l'origine
        const backButton = document.getElementById("btn-back-planning");
        const fromPlanning = sessionStorage.getItem('returnToPlanning') === 'true';
        backButton.style.display = fromPlanning ? 'flex' : 'none';
        
        // Tags
        const saisons = recipe.saisons.split("|").filter((s) => s);
        const diets = recipe.diets.split("|").filter((d) => d);
        document.getElementById("modal-tags").innerHTML = `
          ${saisons.map((s) => `<span class="tag">${s}</span>`).join("")}
          ${diets.map((d) => `<span class="tag">${d}</span>`).join("")}
        `;
        // Meta
        const typeIcon = getTypeIcon(recipe.type_repas);
        document.getElementById("modal-meta").innerHTML = `
          <span>${typeIcon} ${recipe.type_repas || "Plat"}</span>
          <span>‚è±Ô∏è ${recipe.temps} min</span>
          <span>ü•© ${recipe.proteine}</span>
          ${
            recipe.kidsFriendly === "Oui"
              ? "<span>üë∂ Adapt√© enfants</span>"
              : ""
          }
        `;
        // Ingr√©dients
        const ingredients = recipe.ingredients
          .split("|")
          .filter((i) => i.trim());
        document.getElementById("modal-ingredients").innerHTML = ingredients
          .map((ing) => `<li>${ing}</li>`)
          .join("");
        // Instructions
        document.getElementById("modal-instructions").textContent =
          recipe.instructions;
        modal.classList.add("active");
      }
      function closeRecipeModal() {
        modal.classList.remove("active");
        currentRecipe = null;
        // Ne plus retourner automatiquement au planning
        // C'est le bouton "back" qui le fera
        sessionStorage.removeItem('returnToPlanning');
      }
      
      // üéØ NOUVELLE FONCTION : Retour au planning
      function backToPlanning() {
        modal.classList.remove("active");
        currentRecipe = null;
        sessionStorage.removeItem('returnToPlanning');
        planningModal.classList.add("active");
      }
      
      // üéØ NOUVELLE FONCTION : Ouvrir une recette depuis le planning
      function openRecipeFromPlanning(day, meal) {
        const recipe = weeklyPlanning[day]?.[meal];
        if (!recipe) return;
        
        // Marquer qu'on vient du planning pour y retourner apr√®s
        sessionStorage.setItem('returnToPlanning', 'true');
        
        // Fermer la modal planning
        planningModal.classList.remove("active");
        
        // Ouvrir la modal recette
        openRecipeModal(recipe);
      }
      function closePlanningModal() {
        planningModal.classList.remove("active");
      }
      // ============================================
      // AJOUT √Ä LA LISTE DE COURSES
      // ============================================
      function addToShoppingList() {
        if (!currentRecipe) return;
        const ingredients = currentRecipe.ingredients
          .split("|")
          .filter((i) => i.trim());
        // Sauvegarder dans localStorage
        let currentList = JSON.parse(localStorage.getItem('food_home_shopping_list') || '[]');
        const newItems = ingredients.filter(item => !currentList.includes(item));
        currentList = [...currentList, ...newItems];
        localStorage.setItem('food_home_shopping_list', JSON.stringify(currentList));
        
        // Notifier le parent pour refresh
        window.parent.postMessage({
          type: 'SHOPPING_LIST_UPDATED'
        }, '*');
        
        showToast(`‚úÖ ${newItems.length} ingr√©dient(s) ajout√©(s) !`);
      }
      // ============================================
      // PLAT AU HASARD
      // ============================================
      function showRandomRecipe() {
        if (allRecipes.length === 0) return;
        const randomIndex = Math.floor(Math.random() * allRecipes.length);
        openRecipeModal(allRecipes[randomIndex]);
      }
      // ============================================
      // RESET FILTRES
      // ============================================
      function resetFilters() {
        searchInput.value = "";
        typeSelect.value = "";
        saisonSelect.value = "";
        regimeSelect.value = "";
        proteineSelect.value = "";
        filterAndRender();
      }
      // ============================================
      // ERROR
      // ============================================
      function showError(message) {
        resultsDiv.innerHTML = `<div class="empty">‚ùå ${message}</div>`;
      }
      // ============================================
      // EVENT LISTENERS
      // ============================================
      searchInput.addEventListener("input", filterAndRender);
      typeSelect.addEventListener("change", filterAndRender);
      saisonSelect.addEventListener("change", filterAndRender);
      regimeSelect.addEventListener("change", filterAndRender);
      proteineSelect.addEventListener("change", filterAndRender);
      btnRandom.addEventListener("click", showRandomRecipe);
      btnReset.addEventListener("click", resetFilters);
      btnGenerateWeek.addEventListener("click", generateWeeklyPlanning);
      btnRegenerate.addEventListener("click", generateWeeklyPlanning);
      btnExportPlanning.addEventListener("click", exportPlanningToShoppingList);
      btnCloseModal.addEventListener("click", closeRecipeModal);
      btnClosePlanning.addEventListener("click", closePlanningModal);
      btnAddToShopping.addEventListener("click", addToShoppingList);
      
      // üéØ Bouton retour au planning
      document.getElementById("btn-back-planning").addEventListener("click", backToPlanning);
      // Fermer modal en cliquant √† l'ext√©rieur
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeRecipeModal();
      });
      planningModal.addEventListener("click", (e) => {
        if (e.target === planningModal) closePlanningModal();
      });
      // Fermer modal avec Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (modal.classList.contains("active")) closeRecipeModal();
          if (planningModal.classList.contains("active")) closePlanningModal();
        }
      });
      // ============================================
      // ============================================
      // INIT
      // ============================================
      loadRecipes();
      // ============================================
      // TOAST NOTIFICATION (remplace alert)
      // ============================================
      function showToast(message, type = "success") {
        const oldToast = document.querySelector(".toast");
        if (oldToast) oldToast.remove();
        const toast = document.createElement("div");
        toast.className = `toast ${type === "error" ? "error" : ""}`;
       
        const icon = type === "error" ? "‚ùå" : "‚úÖ";
        toast.innerHTML = `<span style="font-size: 24px;">${icon}</span><span>${message}</span>`;
       
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
      
     // Lock body scroll pour mobile/iOS
        let scrollPosition = 0;
        function lockBodyScroll() {
          scrollPosition = window.pageYOffset;
          document.body.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.top = `-${scrollPosition}px`;
          document.body.style.width = '100%';
          document.body.style.overscrollBehavior = 'none';  // Block overscroll
          
          // Prevent touchmove sur body
          document.addEventListener('touchmove', preventDefault, { passive: false });
        }
        
        // Unlock body scroll
        function unlockBodyScroll() {
          document.body.style.overflow = '';
          document.body.style.position = '';
          document.body.style.top = '';
          document.body.style.width = '';
          document.body.style.overscrollBehavior = '';
          window.scrollTo(0, scrollPosition);
          
          // Remove listener
          document.removeEventListener('touchmove', preventDefault);
        }
        
        // Helper preventDefault
        function preventDefault(e) {
          e.preventDefault();
        }
        
        // Dans openRecipeModal(), apr√®s modal.classList.add("active");
        lockBodyScroll();
        
        // Dans closeRecipeModal(), apr√®s modal.classList.remove("active");
        unlockBodyScroll();
        
        // M√™me pour planningModal
        // Dans la fonction qui ouvre planningModal (genre generateWeeklyPlanning()):
        lockBodyScroll();
        
        // Dans closePlanningModal():
        unlockBodyScroll();

        // Dans openRecipeModal(), au lieu de lockBodyScroll() direct :
        window.parent.postMessage({ type: 'LOCK_SCROLL' }, '*');
        
        // Dans closeRecipeModal() :
        window.parent.postMessage({ type: 'UNLOCK_SCROLL' }, '*');
        
        // M√™me pour planningModal
        // Dans generateWeeklyPlanning(), apr√®s planningModal.classList.add("active") :
        window.parent.postMessage({ type: 'LOCK_SCROLL' }, '*');
        
        // Dans closePlanningModal() :
        window.parent.postMessage({ type: 'UNLOCK_SCROLL' }, '*');
        
        // Vire les lockBodyScroll() et unlockBodyScroll() directs dans eat.html, car on d√©l√®gue au parent
        
        // ============================================
        // üéØ GESTION DES FILTRES AVANC√âS
        // ============================================
        function toggleAdvancedFilters() {
          const advancedFilters = document.getElementById('advancedFilters');
          const icon = document.getElementById('filter-toggle-icon');
          const isVisible = advancedFilters.style.display !== 'none';
          
          advancedFilters.style.display = isVisible ? 'none' : 'block';
          icon.textContent = isVisible ? '+' : '‚àí';
        }
        
        // Mettre √† jour le compteur de filtres actifs
        function updateFilterCount() {
          const saison = saisonSelect.value;
          const regime = regimeSelect.value;
          const proteine = proteineSelect.value;
          
          let count = 0;
          if (saison) count++;
          if (regime) count++;
          if (proteine) count++;
          
          const countSpan = document.getElementById('filter-count');
          countSpan.textContent = count > 0 ? `(${count})` : '';
          countSpan.style.fontWeight = count > 0 ? 'var(--font-weight-bold)' : 'normal';
          countSpan.style.color = count > 0 ? '#0ea5e9' : 'inherit';
        }
        
        // √âcouter les changements sur les filtres avanc√©s
        saisonSelect.addEventListener('change', () => {
          updateFilterCount();
          filterAndRender();
        });
        regimeSelect.addEventListener('change', () => {
          updateFilterCount();
          filterAndRender();
        });
        proteineSelect.addEventListener('change', () => {
          updateFilterCount();
          filterAndRender();
        });
        
        // Init le compteur au chargement
        updateFilterCount();
    </script>
  </body>
</html>

