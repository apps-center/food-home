<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Apple Touch Icon pour iPhone -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Nom de l'app sur l'√©cran d'accueil -->
    <meta name="apple-mobile-web-app-title" content="FOOD HOME">
    
    <!-- Mode plein √©cran (masquer la barre Safari) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Couleur de la barre de statut -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon standard pour navigateurs -->
    <link rel="icon" type="image/png" href="/apple-touch-icon.png">
    
    <title>FOOD HOME - Application</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/home.css" />
    <style>
      /* Style suppl√©mentaire pour le bouton Vue Supermarch√© */
      .navbar-controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .supermarket-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      }

      .supermarket-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }

      .supermarket-btn:active {
        transform: translateY(0);
      }

      @media (max-width: 768px) {
        .supermarket-btn {
          font-size: 12px;
          padding: 6px 12px;
        }
        .supermarket-btn span:last-child {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <div class="navbar">
      <div class="navbar-brand">
        <span>üçΩ</span>
        <span>FOOD HOME</span>
      </div>
      <div class="navbar-controls">
        <!-- ‚úÖ NOUVEAU : Bouton Vue Supermarch√© -->
        <button class="supermarket-btn" id="supermarketBtn" onclick="switchToSupermarketView()">
          <span>üõí</span>
          <span>Vue Supermarch√©</span>
        </button>
        
        <button class="toggle-btn" id="toggleBtn">
          <span id="toggleIcon">üîÑ</span>
          <span id="toggleText">Basculer</span>
        </button>
        <a href="javascript:void(0)" class="logout-btn" onclick="logout()"
          >üö™ D√©connexion</a
        >
      </div>
    </div>
    <!-- App Container -->
    <div class="app-container">
      <div class="app-flipper" id="appFlipper">
        <!-- Front Face: Eat App (Meal Planner) - PAR D√âFAUT -->
        <div class="app-face front">
          <iframe
            src="eat"
            id="eatFrame"
            title="Planificateur de repas"
          ></iframe>
        </div>
        <!-- Back Face: Courses App (Shopping List) -->
        <div class="app-face back">
          <iframe
            src="courses"
            id="coursesFrame"
            title="Liste de courses"
          ></iframe>
        </div>
      </div>
    </div>
    <script>
      // üîí V√©rifier la session avant d'afficher l'app
(function checkSession() {
  const isLoggedIn = localStorage.getItem("food_home_logged_in");
  const loginTime = parseInt(localStorage.getItem("food_home_login_time") || "0");
  const now = Date.now();
  // Si pas connect√© ou session expir√©e (24h)
  if (isLoggedIn !== "true" || now - loginTime > 24 * 60 * 60 * 1000) {
    window.location.href = "index.html";
    return;
  }
})();

// Get elements
const toggleBtn = document.getElementById("toggleBtn");
const appFlipper = document.getElementById("appFlipper");
const toggleText = document.getElementById("toggleText");
const toggleIcon = document.getElementById("toggleIcon");
const coursesFrame = document.getElementById("coursesFrame");
const eatFrame = document.getElementById("eatFrame");

// üéØ COMMUNICATION INTER-IFRAMES via postMessage
// √âcouter les messages des iframes enfants
window.addEventListener("message", (event) => {
  // V√©rifier l'origine pour la s√©curit√© (optionnel en local)
  if (event.origin !== window.location.origin) return;

  const { type, data } = event.data;
  switch (type) {
    case "SHOPPING_LIST_UPDATED":
      // Eat a ajout√© des items ‚Üí notifier Courses de rafra√Æchir
      console.log("üî• Shopping list updated, notifying courses iframe...");
      try {
        coursesFrame.contentWindow.postMessage({ type: "REFRESH_DATA" }, "*");
      } catch (e) {
        console.error("Error sending message to courses iframe:", e);
      }
      break;
    case "REQUEST_REFRESH":
      // Courses demande un rafra√Æchissement
      console.log("üîÑ Courses iframe requested refresh");
      try {
        coursesFrame.contentWindow.postMessage({ type: "REFRESH_DATA" }, "*");
      } catch (e) {
        console.error("Error refreshing courses iframe:", e);
      }
      break;
  }
});

// ‚úÖ NOUVELLE FONCTION : Basculer vers Courses ET afficher la vue supermarch√©
function switchToSupermarketView() {
  // Si on n'est pas d√©j√† sur Courses, basculer
  if (!appFlipper.classList.contains("flipped")) {
    appFlipper.classList.add("flipped");
    localStorage.setItem('active_app', 'courses');
    updateToggleButton('courses');
  }
  
  // Envoyer le message pour afficher la vue shopping
  setTimeout(() => {
    try {
      coursesFrame.contentWindow.postMessage({ type: "SHOW_SHOPPING_LIST" }, "*");
      console.log("üì® Message envoy√© : afficher Vue Supermarch√©");
    } catch (e) {
      console.error("Error sending message to courses iframe:", e);
    }
  }, 200);
}

// Toggle between apps
toggleBtn.addEventListener("click", () => {
  toggleBtn.disabled = true;
  appFlipper.classList.toggle("flipped");
  const newApp = appFlipper.classList.contains("flipped") ? "courses" : "eat";
  localStorage.setItem('active_app', newApp);
  updateToggleButton(newApp);
 
  // Quand on bascule vers courses, recharger l'iframe
  if (newApp === "courses") {
    setTimeout(() => {
      try {
        coursesFrame.src = coursesFrame.src;
        console.log("‚úÖ Iframe courses recharg√©e pour refresh");
        
        coursesFrame.onload = () => {
          try {
            coursesFrame.contentWindow.postMessage({ type: "REFRESH_DATA" }, "*");
            console.log("üî® Message envoy√© : refresh data");
          } catch (e) {
            console.error("Error sending message to courses iframe:", e);
          }
        };
      } catch (e) {
        console.error("Error reloading courses iframe:", e);
      }
    }, 100);
  }
  setTimeout(() => { toggleBtn.disabled = false; }, 300);
});

// Update toggle button appearance
function updateToggleButton(app) {
  if (app === "eat") {
    toggleText.textContent = "Vers Courses";
    toggleIcon.textContent = "üõí";
  } else {
    toggleText.textContent = "Vers Repas";
    toggleIcon.textContent = "üçΩÔ∏è";
  }
}

// Keyboard shortcut: Ctrl/Cmd + Space to toggle
document.addEventListener("keydown", (e) => {
  if ((e.ctrlKey || e.metaKey) && e.code === "Space") {
    e.preventDefault();
    toggleBtn.click();
  }
});

// Log au chargement et set initial state from localStorage
window.addEventListener("load", () => {
  const currentApp = localStorage.getItem('active_app') || "eat";
  if (currentApp === "courses") {
    appFlipper.classList.add("flipped");
    updateToggleButton("courses");
  } else {
    updateToggleButton("eat");
  }
  console.log("‚úÖ FOOD HOME loaded - postMessage communication ready");
});

// Fonction de d√©connexion
function logout() {
  localStorage.removeItem("food_home_logged_in");
  localStorage.removeItem("food_home_login_time");
  localStorage.removeItem("active_app");
  window.location.href = "index.html";
}
    </script>
  </body>
</html>
